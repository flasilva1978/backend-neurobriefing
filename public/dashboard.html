<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dossi√™ NeuroBriefing</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    
    <style>
        /* --- RESET E GERAL --- */
        * { box-sizing: border-box; }
        body { font-family: 'Montserrat', sans-serif; background: #e0e5ec; margin: 0; padding: 20px; color: #333; }
        
        /* Painel de Controle (Tela) */
        .painel { max-width: 1000px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 30px; }
        .header-painel { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding-bottom: 15px; margin-bottom: 15px; }
        .btn { background: #2c3e50; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: 700; font-size: 10pt; transition: 0.2s; }
        .btn:hover { background: #34495e; }
        table { width: 100%; border-collapse: collapse; font-size: 10pt; }
        th { text-align: left; padding: 10px; background: #34495e; color: white; }
        td { padding: 10px; border-bottom: 1px solid #eee; }

        /* --- PDF A4 (ESTRUTURA R√çGIDA) --- */
        #relatorio-pdf { display: none; margin: 0 auto; }
        
        .page { 
            width: 210mm; 
            height: 296mm; /* Altura A4 padr√£o */
            background: white; 
            position: relative; 
            overflow: hidden; /* Corta excessos */
            page-break-after: always; /* For√ßa nova p√°gina */
            padding: 0; /* Controle total interno */
        }
        .page:last-child { page-break-after: auto; }

        /* --- P√ÅGINA 1: CAPA --- */
        .capa-container { 
            height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center; 
            background: linear-gradient(135deg, #fdfbfb 0%, #ebedee 100%);
            border: 15mm solid white; /* Moldura branca */
        }
        .capa-logo { font-size: 40pt; font-weight: 900; letter-spacing: -2px; color: #2c3e50; margin-bottom: 10px; }
        .capa-sub { font-size: 10pt; letter-spacing: 5px; text-transform: uppercase; color: #7f8c8d; margin-bottom: 60px; }
        
        .capa-info { text-align: center; border-top: 2px solid #2c3e50; border-bottom: 2px solid #2c3e50; padding: 30px 50px; }
        .ci-label { font-size: 8pt; font-weight: 700; color: #95a5a6; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 5px; display: block; }
        .ci-val { font-size: 16pt; font-weight: 600; color: #2c3e50; margin-bottom: 20px; display: block; }
        .ci-val:last-child { margin-bottom: 0; }

        .capa-footer { position: absolute; bottom: 15mm; font-size: 8pt; color: #bdc3c7; letter-spacing: 1px; }

        /* --- P√ÅGINA 2: M√ìDULO 1 --- */
        .mod-container { padding: 15mm; height: 100%; display: flex; flex-direction: column; }
        
        /* Cabe√ßalho do M√≥dulo */
        .mod-header { 
            display: flex; justify-content: space-between; align-items: flex-end; 
            border-bottom: 3px solid #2c3e50; padding-bottom: 10px; margin-bottom: 20px; 
        }
        .mh-title { font-size: 18pt; font-weight: 800; color: #2c3e50; text-transform: uppercase; line-height: 1; }
        .mh-sub { font-size: 8pt; color: #7f8c8d; text-transform: uppercase; font-weight: 600; }

        /* Gr√°fico de Barras */
        .chart-row { display: flex; gap: 10px; margin-bottom: 25px; height: 70px; }
        .chart-card { flex: 1; background: #f8f9fa; border-radius: 6px; padding: 8px; display: flex; flex-direction: column; justify-content: space-between; border: 1px solid #e0e0e0; }
        .cc-head { display: flex; justify-content: space-between; align-items: center; }
        .cc-label { font-size: 8pt; font-weight: 800; text-transform: uppercase; }
        .cc-val { font-size: 14pt; font-weight: 900; }
        .cc-bar-bg { width: 100%; height: 6px; background: #ddd; border-radius: 3px; overflow: hidden; }
        .cc-bar-fill { height: 100%; border-radius: 3px; }

        /* Resultado Dominante (O Core) */
        .result-box { flex: 1; border: 1px solid #ddd; border-radius: 8px; overflow: hidden; display: flex; flex-direction: column; margin-bottom: 20px; }
        
        .rb-header { padding: 15px 20px; color: white; display: flex; justify-content: space-between; align-items: center; }
        .rb-title { font-size: 14pt; font-weight: 900; text-transform: uppercase; }
        .rb-subtitle { font-size: 9pt; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; opacity: 0.9; }

        .rb-body { display: flex; flex: 1; }
        .rb-col { flex: 1; padding: 20px; }
        .rb-left { background: #fff; border-right: 1px dashed #eee; }
        .rb-right { background: #fcfcfc; }

        /* Itens de Texto */
        .info-item { margin-bottom: 12px; }
        .ii-label { font-size: 7pt; font-weight: 700; color: #95a5a6; text-transform: uppercase; display: block; margin-bottom: 3px; }
        .ii-val { font-size: 10pt; font-weight: 600; color: #333; line-height: 1.3; }

        .list-group { margin-bottom: 15px; }
        .lg-title { font-size: 9pt; font-weight: 800; color: #2c3e50; text-transform: uppercase; margin-bottom: 8px; display: flex; align-items: center; gap: 5px; }
        .lg-list { padding: 0; margin: 0; list-style: none; }
        .lg-list li { font-size: 8.5pt; color: #555; margin-bottom: 4px; padding-left: 10px; border-left: 2px solid #eee; line-height: 1.2; }

        /* Rodap√© Informativo */
        .footer-info { display: flex; gap: 15px; height: 100px; }
        .fi-box { flex: 1; border: 1px solid #eee; border-radius: 6px; padding: 10px; background: #fafafa; }
        .fi-title { font-size: 8pt; font-weight: 700; text-transform: uppercase; color: #7f8c8d; border-bottom: 1px solid #ddd; padding-bottom: 5px; margin-bottom: 8px; }
        
        .rank-item { font-size: 8pt; display: flex; justify-content: space-between; margin-bottom: 4px; }
        .ri-name { font-weight: 700; color: #2c3e50; }
        .ri-desc { font-style: italic; color: #777; }

        .quote { font-size: 8pt; color: #555; font-style: italic; text-align: center; margin-top: 10px; line-height: 1.4; }

        /* Cores Utilit√°rias */
        .c-fogo { color: #e74c3c; } .bg-fogo { background: #e74c3c; }
        .c-ar { color: #3498db; } .bg-ar { background: #3498db; }
        .c-agua { color: #2980b9; } .bg-agua { background: #2980b9; }
        .c-terra { color: #27ae60; } .bg-terra { background: #27ae60; }

    </style>
</head>
<body>

    <div class="painel">
        <div class="header-painel">
            <div>
                <h2 style="margin:0;">Dashboard Administrativo</h2>
                <span style="font-size:10pt; color:#777;">Gera√ß√£o de Dossi√™s</span>
            </div>
            <button class="btn" onclick="location.reload()">Atualizar Lista</button>
        </div>
        <table>
            <thead><tr><th>Data</th><th>Cliente</th><th>Status</th><th style="text-align:right">A√ß√£o</th></tr></thead>
            <tbody id="lista"><tr><td colspan="4">Carregando...</td></tr></tbody>
        </table>
    </div>

    <div id="relatorio-pdf">
        
        <div class="page">
            <div class="capa-container">
                <div class="capa-logo">NEUROBRIEFING</div>
                <div class="capa-sub">Diagn√≥stico Integral & Estrat√©gia</div>
                
                <div class="capa-info">
                    <span class="ci-label">Cliente Analisado</span>
                    <span class="ci-val" id="capa-nome">-</span>
                    
                    <span class="ci-label">Arquiteto Respons√°vel</span>
                    <span class="ci-val" id="capa-arq">-</span>

                    <span class="ci-label">Data do Diagn√≥stico</span>
                    <span class="ci-val" id="capa-data">-</span>
                </div>

                <div class="capa-footer">Documento Confidencial de Uso Profissional</div>
            </div>
        </div>

        <div class="page">
            <div class="mod-container">
                <div class="mod-header">
                    <div class="mh-title">1. Identidade do Ser</div>
                    <div class="mh-sub">Comportamento, Arqu√©tipo & Temperamento</div>
                </div>

                <div class="chart-row">
                    <div class="chart-card">
                        <div class="cc-head"><span class="cc-label c-fogo">Fogo</span><span class="cc-val" id="v-fogo">0</span></div>
                        <div class="cc-bar-bg"><div class="cc-bar-fill bg-fogo" id="b-fogo"></div></div>
                    </div>
                    <div class="chart-card">
                        <div class="cc-head"><span class="cc-label c-ar">Ar</span><span class="cc-val" id="v-ar">0</span></div>
                        <div class="cc-bar-bg"><div class="cc-bar-fill bg-ar" id="b-ar"></div></div>
                    </div>
                    <div class="chart-card">
                        <div class="cc-head"><span class="cc-label c-agua">√Ågua</span><span class="cc-val" id="v-agua">0</span></div>
                        <div class="cc-bar-bg"><div class="cc-bar-fill bg-agua" id="b-agua"></div></div>
                    </div>
                    <div class="chart-card">
                        <div class="cc-head"><span class="cc-label c-terra">Terra</span><span class="cc-val" id="v-terra">0</span></div>
                        <div class="cc-bar-bg"><div class="cc-bar-fill bg-terra" id="b-terra"></div></div>
                    </div>
                </div>

                <div class="result-box">
                    <div class="rb-header" id="rb-header">
                        <div class="rb-title" id="txt-elemento">ELEMENTO -</div>
                        <div class="rb-subtitle" id="txt-estilo">-</div>
                    </div>
                    
                    <div class="rb-body">
                        <div class="rb-col rb-left">
                            <div class="info-item">
                                <span class="ii-label">‚ö° Energia</span>
                                <div class="ii-val" id="txt-energia">-</div>
                            </div>
                            <div class="info-item">
                                <span class="ii-label">üë§ Para Quem</span>
                                <div class="ii-val" id="txt-quem">-</div>
                            </div>
                            <div class="info-item">
                                <span class="ii-label">üìã Perfil & Temperamento</span>
                                <div class="ii-val"><span id="txt-perfil">-</span> | <span id="txt-temp">-</span></div>
                            </div>
                            <div class="info-item">
                                <span class="ii-label">üé≠ Arqu√©tipos</span>
                                <div class="ii-val" id="txt-arq">-</div>
                            </div>
                        </div>

                        <div class="rb-col rb-right">
                            <div class="list-group">
                                <div class="lg-title" style="color:#2c3e50;">üè† Estilos Inclu√≠dos</div>
                                <ul class="lg-list" id="list-estilos"></ul>
                            </div>
                            <div class="list-group">
                                <div class="lg-title" style="color:#2c3e50;">‚ú® Caracter√≠sticas</div>
                                <ul class="lg-list" id="list-carac"></ul>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="footer-info">
                    <div class="fi-box">
                        <div class="fi-title">üìä Leitura do Diagn√≥stico</div>
                        <div class="rank-item">
                            <span class="ri-name">1Ô∏è‚É£ Dominante <span id="r-dom"></span></span>
                            <span class="ri-desc">Energia atual</span>
                        </div>
                        <div class="rank-item">
                            <span class="ri-name">2Ô∏è‚É£ Secund√°rio <span id="r-sec"></span></span>
                            <span class="ri-desc">Recurso acess√≠vel</span>
                        </div>
                        <div class="rank-item">
                            <span class="ri-name">3Ô∏è‚É£ Menos Acessado <span id="r-last"></span></span>
                            <span class="ri-desc">A desenvolver</span>
                        </div>
                    </div>
                    <div class="fi-box" style="display:flex; align-items:center; justify-content:center; background:#fffcf0; border-color:#fcefdc;">
                        <div class="quote">
                            "Voc√™ n√£o √© um tipo fixo. Voc√™ √© um sistema vivo em equil√≠brio din√¢mico. A neuroarquitetura busca harmonizar sua natureza com o espa√ßo."
                        </div>
                    </div>
                </div>

            </div>
        </div>

    </div>

    <script>
        // --- BASE DE DADOS COMPLETA ---
        const DB = {
            FOGO: {
                cor: '#e74c3c',
                titulo: 'ESTILOS DE ATIVA√á√ÉO',
                energia: 'A√ß√£o ¬∑ Dire√ß√£o ¬∑ Intensidade',
                quem: 'Pessoas executor-col√©ricas, arqu√©tipos de a√ß√£o',
                perfil: 'Executor',
                temp: 'Col√©rico',
                arq: 'Her√≥i ¬∑ Governante ¬∑ Fora-da-Lei',
                estilos: ['Contempor√¢neo', 'Industrial', 'Moderno Urbano', 'High Tech', 'Luxo Moderno'],
                carac: ['Contrastes marcantes', 'Linhas retas e definidas', 'Materiais fortes (metal, concreto, couro)', 'Ilumina√ß√£o direcionada', 'Paleta com profundidade']
            },
            AR: {
                cor: '#3498db',
                titulo: 'ESTILOS DE EXPRESS√ÉO',
                energia: 'Express√£o ¬∑ Conex√£o ¬∑ Movimento',
                quem: 'Comunicador-sangu√≠neo, arqu√©tipos relacionais',
                perfil: 'Comunicador',
                temp: 'Sangu√≠neo',
                arq: 'Amante ¬∑ Bobo da Corte ¬∑ Explorador',
                estilos: ['Escandinavo', 'Contempor√¢neo Leve', 'Mid-Century Modern', 'Boho Chic', 'Ecl√©tico Curado'],
                carac: ['Luz natural abundante', 'Layout fluido e aberto', 'Mistura criativa de elementos', 'Cores claras com pontos vibrantes', 'Sensa√ß√£o de liberdade']
            },
            AGUA: {
                cor: '#2980b9',
                titulo: 'ESTILOS DE ACOLHIMENTO',
                energia: 'Sensibilidade ¬∑ Adapta√ß√£o ¬∑ Ritmo',
                quem: 'Planejador-fleum√°tico, arqu√©tipos do cuidado',
                perfil: 'Planejador',
                temp: 'Fleum√°tico',
                arq: 'Cuidador ¬∑ Inocente ¬∑ Mago',
                estilos: ['Japandi', 'Org√¢nico Contempor√¢neo', 'Wabi-Sabi', 'Coastal Sofisticado', 'Natural Chic'],
                carac: ['Texturas suaves e t√°teis', 'Paleta neutra quente', 'Materiais naturais (linho, madeira clara)', 'Ilumina√ß√£o difusa', 'Ambientes que desaceleram']
            },
            TERRA: {
                cor: '#27ae60',
                titulo: 'ESTILOS DE ESTRUTURA',
                energia: 'Estrutura ¬∑ Profundidade ¬∑ Const√¢ncia',
                quem: 'Analista-melanc√≥lico, arqu√©tipos de sabedoria',
                perfil: 'Analista',
                temp: 'Melanc√≥lico',
                arq: 'S√°bio ¬∑ Criador ¬∑ √ìrf√£o',
                estilos: ['Cl√°ssico Atemporal', 'Neocl√°ssico', 'Tradicional Contempor√¢neo', 'Moderno Elegante', 'Colonial Atualizado'],
                carac: ['Propor√ß√£o e simetria', 'Materiais nobres e dur√°veis', 'Paleta s√≥bria e profunda', 'Organiza√ß√£o visual clara', 'Sensa√ß√£o de perman√™ncia']
            }
        };

        let dadosAPI = [];

        async function init() {
            try {
                const req = await fetch('https://api-neurobriefing.onrender.com/api/relatorios');
                dadosAPI = await req.json();
                renderTable();
            } catch(e) { console.error(e); }
        }

        function renderTable() {
            const tbody = document.getElementById('lista');
            tbody.innerHTML = '';
            if(dadosAPI.length === 0) { tbody.innerHTML = '<tr><td colspan="4">Sem dados.</td></tr>'; return; }
            
            [...dadosAPI].reverse().forEach((d, i) => {
                const idx = dadosAPI.length - 1 - i;
                tbody.innerHTML += `
                    <tr>
                        <td>${new Date(d.data).toLocaleDateString()}</td>
                        <td><strong>${d.cliente}</strong></td>
                        <td><span style="color:green; font-weight:bold;">Conclu√≠do</span></td>
                        <td style="text-align:right"><button class="btn" onclick="gerarPDF(${idx}, this)">Gerar PDF</button></td>
                    </tr>
                `;
            });
        }

        async function gerarPDF(index, btn) {
            const dados = dadosAPI[index];
            const originalTxt = btn.innerText; btn.innerText = "Gerando..."; btn.disabled = true;

            // --- 1. POPULAR CAPA ---
            document.getElementById('capa-nome').innerText = dados.cliente;
            document.getElementById('capa-arq').innerText = dados.contato?.arquiteto || 'N√£o informado';
            document.getElementById('capa-data').innerText = new Date(dados.data).toLocaleDateString();

            // --- 2. C√ÅLCULOS M√ìDULO 1 ---
            let pts = { FOGO:0, AR:0, AGUA:0, TERRA:0 };
            const resp = dados.respostas || {};
            
            Object.keys(resp).forEach(k => {
                let val = parseInt(resp[k], 10) || 0;
                if(k.includes('fogo')) pts.FOGO += val;
                if(k.includes('ar')) pts.AR += val;
                if(k.includes('agua')) pts.AGUA += val;
                if(k.includes('terra')) pts.TERRA += val;
            });

            // Encontra vencedor
            const sorted = [
                { id: 'FOGO', val: pts.FOGO, ...DB.FOGO },
                { id: 'AR', val: pts.AR, ...DB.AR },
                { id: 'AGUA', val: pts.AGUA, ...DB.AGUA },
                { id: 'TERRA', val: pts.TERRA, ...DB.TERRA }
            ].sort((a,b) => b.val - a.val);

            const dom = sorted[0]; // 1¬∫
            const sec = sorted[1]; // 2¬∫
            const last = sorted[3]; // 4¬∫

            // Preenche Barras
            ['FOGO','AR','AGUA','TERRA'].forEach(key => {
                const kLower = key.toLowerCase();
                const score = pts[key];
                document.getElementById(`v-${kLower}`).innerText = score;
                document.getElementById(`b-${kLower}`).style.width = Math.min((score/25)*100, 100) + '%';
            });

            // Preenche Box Dominante
            const header = document.getElementById('rb-header');
            header.style.backgroundColor = dom.cor;
            document.getElementById('txt-elemento').innerText = `ELEMENTO ${dom.id}`;
            document.getElementById('txt-estilo').innerText = dom.titulo;

            // Dados Psico
            document.getElementById('txt-energia').innerText = dom.energia;
            document.getElementById('txt-quem').innerText = dom.quem;
            document.getElementById('txt-perfil').innerText = dom.perfil;
            document.getElementById('txt-temp').innerText = dom.temp;
            document.getElementById('txt-arq').innerText = dom.arq;

            // Listas
            document.getElementById('list-estilos').innerHTML = dom.estilos.map(x => `<li>${x}</li>`).join('');
            document.getElementById('list-carac').innerHTML = dom.carac.map(x => `<li>${x}</li>`).join('');

            // Ranking Rodap√©
            document.getElementById('r-dom').innerText = `${dom.id} (${dom.val})`;
            document.getElementById('r-sec').innerText = `${sec.id} (${sec.val})`;
            document.getElementById('r-last').innerText = `${last.id} (${last.val})`;

            // --- 3. EXPORTAR PDF ---
            const element = document.getElementById('relatorio-pdf');
            element.style.display = 'block';

            setTimeout(async () => {
                const opt = {
                    margin: 0,
                    filename: `Dossie_${dados.cliente}.pdf`,
                    image: { type: 'jpeg', quality: 0.98 },
                    html2canvas: { scale: 2, useCORS: true },
                    jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
                };
                await html2pdf().set(opt).from(element).save();
                
                element.style.display = 'none';
                btn.innerText = originalTxt; btn.disabled = false;
            }, 800);
        }

        init();
    </script>
</body>
</html>