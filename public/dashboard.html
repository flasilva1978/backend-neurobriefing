<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel NeuroBriefing | Modular</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    
    <style>
        /* ESTILOS BASE */
        body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; margin: 0; padding: 20px; color: #333; }
        .painel { max-width: 1200px; margin: 0 auto; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 5px 20px rgba(0,0,0,0.05); }
        .header-painel { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 15px; }
        .btn { background: #2c3e50; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: bold; }
        table { width: 100%; border-collapse: collapse; font-size: 13px; }
        th { text-align: left; padding: 12px; background: #34495e; color: white; }
        td { padding: 12px; border-bottom: 1px solid #eee; }

        /* PDF CONFIG */
        #relatorio-pdf { width: 210mm; background: white; margin: 40px auto; display: none; }
        .pagina { width: 210mm; min-height: 296mm; padding: 15mm; box-sizing: border-box; position: relative; background: white; page-break-before: always; }
        .pagina:first-child { page-break-before: auto; }

        /* TIPOGRAFIA RELAT√ìRIO */
        h1, h2, h3, h4 { font-family: 'Montserrat', sans-serif; margin: 0; }
        .brand { font-size: 22pt; font-weight: 900; color: #2c3e50; letter-spacing: -1px; }
        .sub-brand { font-size: 9pt; letter-spacing: 3px; text-transform: uppercase; color: #7f8c8d; margin-bottom: 20px; display: block; }
        
        .mod-header { background: #2c3e50; color: white; padding: 8px 15px; border-radius: 4px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; margin-top: 10px; }
        .mod-title { font-size: 12pt; font-weight: 700; text-transform: uppercase; }

        /* M√ìDULO 1: GR√ÅFICO */
        .row-perfil { display: flex; gap: 10px; margin-bottom: 15px; }
        .card-perfil { flex: 1; border: 1px solid #eee; border-radius: 6px; padding: 8px; text-align: center; }
        .cp-val { font-size: 18pt; font-weight: 800; display: block; margin-top: 5px; }
        .bar-bg { width: 100%; height: 6px; background: #eee; border-radius: 3px; margin-top: 5px; }
        .bar-fill { height: 100%; border-radius: 3px; }

        /* BOX DE RESULTADO DETALHADO */
        .resumo-box { border: 1px solid #e0e0e0; border-radius: 8px; padding: 15px; background: #fdfdfd; margin-top: 10px; }
        .resumo-title { color: #e74c3c; font-weight: 800; font-size: 11pt; text-transform: uppercase; margin-bottom: 10px; border-bottom: 2px solid #f1f1f1; padding-bottom: 5px; }
        
        .detail-row { display: flex; margin-bottom: 8px; font-size: 9pt; align-items: baseline; }
        .detail-label { font-weight: 700; color: #2c3e50; width: 100px; }
        .detail-val { color: #555; font-style: italic; }

        .interpretacao-box { background: #f0f7fa; padding: 15px; border-radius: 6px; margin-top: 15px; border-left: 4px solid #3498db; }
        .principio-box { background: #fffcf0; padding: 15px; border-radius: 6px; margin-top: 10px; border-left: 4px solid #f1c40f; }
        
        .destaque-txt { font-weight: 700; color: #2c3e50; }
        .lista-ranking { list-style: none; padding: 0; margin: 10px 0; }
        .lista-ranking li { font-size: 9pt; margin-bottom: 4px; padding: 4px; background: #fff; border: 1px solid #eee; }

        /* FOOTER */
        .footer { position: absolute; bottom: 10mm; left: 15mm; right: 15mm; text-align: center; font-size: 7pt; color: #aaa; border-top: 1px solid #eee; padding-top: 5px; }

        /* CORES */
        .c-fogo { color: #e74c3c; } .bg-fogo { background: #e74c3c; }
        .c-ar { color: #3498db; } .bg-ar { background: #3498db; }
        .c-agua { color: #2980b9; } .bg-agua { background: #2980b9; }
        .c-terra { color: #27ae60; } .bg-terra { background: #27ae60; }
    </style>
</head>
<body>

    <div class="painel">
        <div class="header-painel">
            <h2>Gest√£o NeuroBriefing</h2>
            <button class="btn" onclick="location.reload()">Atualizar</button>
        </div>
        <table>
            <thead><tr><th>Data</th><th>Cliente</th><th>M√≥dulos</th><th>A√ß√£o</th></tr></thead>
            <tbody id="lista"><tr><td colspan="4">Carregando...</td></tr></tbody>
        </table>
    </div>

    <div id="relatorio-pdf">
        
        <div class="pagina">
            <div style="text-align:center; margin-bottom:30px;">
                <div class="brand">NEUROBRIEFING</div>
                <span class="sub-brand">DIAGN√ìSTICO INTEGRAL & ESTRAT√âGIA</span>
                
                <div style="font-size:9pt; background:#f8f9fa; padding:10px; display:inline-block; border-radius:4px;">
                    CLIENTE: <strong id="r-nome">-</strong> | DATA: <span id="r-data">-</span>
                </div>
            </div>

            <div class="mod-header">
                <div class="mod-title">1. Identidade do Ser</div>
                <div style="font-size:8pt; opacity:0.8;">Arqu√©tipo & Temperamento</div>
            </div>
            
            <div class="row-perfil">
                <div class="card-perfil"><span class="c-fogo" style="font-weight:800;">FOGO</span><span class="cp-val" id="v-fogo">0</span><div class="bar-bg"><div class="bar-fill bg-fogo" id="b-fogo"></div></div></div>
                <div class="card-perfil"><span class="c-ar" style="font-weight:800;">AR</span><span class="cp-val" id="v-ar">0</span><div class="bar-bg"><div class="bar-fill bg-ar" id="b-ar"></div></div></div>
                <div class="card-perfil"><span class="c-agua" style="font-weight:800;">√ÅGUA</span><span class="cp-val" id="v-agua">0</span><div class="bar-bg"><div class="bar-fill bg-agua" id="b-agua"></div></div></div>
                <div class="card-perfil"><span class="c-terra" style="font-weight:800;">TERRA</span><span class="cp-val" id="v-terra">0</span><div class="bar-bg"><div class="bar-fill bg-terra" id="b-terra"></div></div></div>
            </div>

            <div class="resumo-box">
                <div class="resumo-title">RESULTADO DO TESTE</div>
                
                <div style="background:#fff; padding:10px; border-left:5px solid #333; margin-bottom:15px;" id="box-dominante">
                    <h3 style="margin:0; font-size:14pt; color:#333;" id="txt-elemento">ELEMENTO -</h3>
                    <div style="margin-top:5px;">
                        <div class="detail-row"><span class="detail-label">Energia:</span> <span class="detail-val" id="txt-energia">-</span></div>
                        <div class="detail-row"><span class="detail-label">Perfil:</span> <span class="detail-val" id="txt-perfil">-</span></div>
                        <div class="detail-row"><span class="detail-label">Temperamento:</span> <span class="detail-val" id="txt-temp">-</span></div>
                        <div class="detail-row"><span class="detail-label">Arqu√©tipos:</span> <span class="detail-val" id="txt-arq">-</span></div>
                    </div>
                </div>

                <div class="resumo-title" style="font-size:9pt; color:#555; border:none; margin-bottom:5px;">üìä LEITURA DO DIAGN√ìSTICO</div>
                <ul class="lista-ranking" id="lista-ranking">
                    </ul>
            </div>

            <div class="interpretacao-box">
                <div class="destaque-txt" style="margin-bottom:5px;">üß© INTERPRETA√á√ÉO INTEGRADA</div>
                <div style="font-size:8.5pt; color:#444; line-height:1.4;">
                    <strong>Elemento dominante</strong> ‚Üí como a energia se manifesta<br>
                    <strong>Temperamento</strong> ‚Üí rea√ß√£o emocional b√°sica<br>
                    <strong>Perfil comportamental</strong> ‚Üí forma de agir no mundo<br>
                    <strong>Arqu√©tipos</strong> ‚Üí motiva√ß√µes profundas ativas
                </div>
            </div>

            <div class="principio-box">
                <div class="destaque-txt" style="margin-bottom:5px;">‚ú® PRINC√çPIO FUNDAMENTAL</div>
                <div style="font-size:8.5pt; color:#555; font-style:italic;">
                    "Voc√™ n√£o √© um tipo. Voc√™ √© um sistema vivo em equil√≠brio din√¢mico."
                </div>
                <div style="margin-top:8px; font-size:8.5pt;">
                    <strong>APLICA√á√ïES:</strong> Orientar a conduta do projeto e criar estrat√©gias para equilibrar os ambientes residencial ou comercial.
                </div>
            </div>

            <div class="footer">P√°gina 1 - Identidade do Ser | NeuroBriefing Intelligence</div>
        </div>
        
        <div id="paginas-extras"></div>

    </div>

    <script>
        // DADOS DE REFER√äNCIA (TEXTOS FIXOS)
        const DEFINICOES = {
            FOGO: { cor:'#e74c3c', energia: 'A√ß√£o ¬∑ Dire√ß√£o ¬∑ Intensidade', perfil: 'Executor', temp: 'Col√©rico', arq: 'Her√≥i ¬∑ Governante ¬∑ Fora-da-Lei' },
            AR:   { cor:'#3498db', energia: 'Express√£o ¬∑ Conex√£o ¬∑ Movimento', perfil: 'Comunicador', temp: 'Sangu√≠neo', arq: 'Amante ¬∑ Bobo da Corte ¬∑ Explorador' },
            AGUA: { cor:'#2980b9', energia: 'Sensibilidade ¬∑ Adapta√ß√£o ¬∑ Ritmo', perfil: 'Planejador', temp: 'Fleum√°tico', arq: 'Cuidador ¬∑ Inocente ¬∑ Mago' },
            TERRA:{ cor:'#27ae60', energia: 'Estrutura ¬∑ Profundidade ¬∑ Const√¢ncia', perfil: 'Analista', temp: 'Melanc√≥lico', arq: 'S√°bio ¬∑ Criador ¬∑ √ìrf√£o' }
        };

        let dadosAPI = [];

        async function init() {
            try {
                const req = await fetch('https://api-neurobriefing.onrender.com/api/relatorios');
                dadosAPI = await req.json();
                renderLista();
            } catch(e) { console.log(e); }
        }

        function renderLista() {
            const tbody = document.getElementById('lista');
            tbody.innerHTML = '';
            [...dadosAPI].reverse().forEach((d, i) => {
                const idx = dadosAPI.length - 1 - i;
                tbody.innerHTML += `<tr>
                    <td>${new Date(d.data).toLocaleDateString()}</td>
                    <td><strong>${d.cliente}</strong></td>
                    <td>${d.modulosCompletos ? '‚úÖ Completo' : '‚ö†Ô∏è Parcial'}</td>
                    <td style="text-align:right"><button class="btn" onclick="gerarPDF(${idx}, this)">üìÑ Dossi√™</button></td>
                </tr>`;
            });
        }

        async function gerarPDF(index, btn) {
            const dados = dadosAPI[index];
            const originalTxt = btn.innerText; 
            btn.innerText = "Gerando..."; btn.disabled = true;

            // 1. C√ÅLCULOS DO M√ìDULO 1
            let pts = { FOGO:0, AR:0, AGUA:0, TERRA:0 };
            const resp = dados.respostas || {};

            Object.keys(resp).forEach(k => {
                let val = parseInt(resp[k], 10) || 0;
                if(k.includes('fogo')) pts.FOGO += val;
                if(k.includes('ar')) pts.AR += val;
                if(k.includes('agua')) pts.AGUA += val;
                if(k.includes('terra')) pts.TERRA += val;
            });

            // Ordenar Scores (Do maior para o menor)
            let scores = [
                { id: 'FOGO', val: pts.FOGO, ...DEFINICOES.FOGO },
                { id: 'AR', val: pts.AR, ...DEFINICOES.AR },
                { id: 'AGUA', val: pts.AGUA, ...DEFINICOES.AGUA },
                { id: 'TERRA', val: pts.TERRA, ...DEFINICOES.TERRA }
            ].sort((a,b) => b.val - a.val);

            // Preencher Capa
            document.getElementById('r-nome').innerText = dados.cliente;
            document.getElementById('r-data').innerText = new Date(dados.data).toLocaleDateString();

            // Barras Coloridas
            ['fogo','ar','agua','terra'].forEach(id => {
                const k = id.toUpperCase();
                const score = pts[k];
                document.getElementById('v-'+id).innerText = score;
                document.getElementById('b-'+id).style.width = Math.min((score/25)*100, 100) + '%';
            });

            // Preencher Box Dominante
            const dom = scores[0];
            document.getElementById('box-dominante').style.borderLeftColor = dom.cor;
            document.getElementById('txt-elemento').innerText = `ELEMENTO ${dom.id}`;
            document.getElementById('txt-elemento').style.color = dom.cor;
            
            document.getElementById('txt-energia').innerText = dom.energia;
            document.getElementById('txt-perfil').innerText = dom.perfil;
            document.getElementById('txt-temp').innerText = dom.temp;
            document.getElementById('txt-arq').innerText = dom.arq;

            // Preencher Ranking
            const rankingList = document.getElementById('lista-ranking');
            rankingList.innerHTML = `
                <li><strong>1Ô∏è‚É£ Elemento Dominante:</strong> ${dom.id} (${dom.val} pts) <span style="color:#777">‚Üí Energia predominante atual</span></li>
                <li><strong>2Ô∏è‚É£ Elemento Secund√°rio:</strong> ${scores[1].id} (${scores[1].val} pts) <span style="color:#777">‚Üí Recurso acess√≠vel</span></li>
                <li><strong>3Ô∏è‚É£ Elemento Menos Acessado:</strong> ${scores[3].id} (${scores[3].val} pts) <span style="color:#777">‚Üí √Årea de desenvolvimento</span></li>
            `;

            // GERAR P√ÅGINAS EXTRAS (VISUAL, SENSORIAL, ETC) - L√≥gica Simplificada para Exibi√ß√£o
            // ... (Aqui voc√™ pode manter a l√≥gica anterior de appendChild para os outros m√≥dulos)

            // EXPORTAR
            const element = document.getElementById('relatorio-pdf');
            element.style.display = 'block';

            setTimeout(async () => {
                const opt = {
                    margin: 0,
                    filename: `Dossie_${dados.cliente}.pdf`,
                    image: { type: 'jpeg', quality: 0.98 },
                    html2canvas: { scale: 2 },
                    jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
                };
                await html2pdf().set(opt).from(element).save();
                element.style.display = 'none';
                btn.innerText = originalTxt; btn.disabled = false;
            }, 1000);
        }

        init();
    </script>
</body>
</html>