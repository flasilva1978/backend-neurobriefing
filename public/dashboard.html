<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel NeuroBriefing | Gest√£o</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600;800&display=swap" rel="stylesheet">
    
    <style>
        /* --- ESTILOS DO SISTEMA (TELA PC) --- */
        body { font-family: 'Segoe UI', sans-serif; background: #eaeff2; margin: 0; color: #333; }
        .sys-header { background: #1e272e; padding: 15px; text-align: center; color: #fff; letter-spacing: 1px; }
        .sys-container { max-width: 1100px; margin: 30px auto; padding: 20px; }
        .card-lista { background: white; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); padding: 25px; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 13px; }
        th { background: #f1f2f6; text-align: left; padding: 12px; border-bottom: 2px solid #dcdde1; color: #57606f; font-weight: 700; }
        td { padding: 12px; border-bottom: 1px solid #eee; }
        
        .btn-pdf { background: #ff4757; color: white; border: none; padding: 7px 14px; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 11px; transition: 0.2s; }
        .btn-pdf:hover { background: #ff6b81; transform: translateY(-1px); }

        /* --- DESIGN DO PDF (FOLHA A4 ONE PAGE) --- */
        #folha-a4 {
            width: 210mm; height: 296mm; /* A4 Exato */
            background: white; margin: 0 auto; 
            padding: 12mm 15mm; 
            box-sizing: border-box; 
            display: none; /* Oculto na tela */
            position: relative;
            font-family: 'Montserrat', sans-serif;
            color: #2f3542;
            overflow: hidden;
        }

        /* HEADER */
        .pdf-header { 
            display: flex; justify-content: space-between; align-items: flex-end; 
            border-bottom: 3px solid #2f3542; padding-bottom: 10px; margin-bottom: 20px; 
        }
        .brand h1 { margin: 0; font-size: 22pt; font-weight: 800; letter-spacing: -1px; line-height: 1; }
        .brand span { font-size: 8pt; text-transform: uppercase; letter-spacing: 3px; color: #747d8c; }
        .meta { text-align: right; font-size: 7.5pt; line-height: 1.4; color: #57606f; }
        .meta strong { color: #000; font-size: 9pt; }

        /* COLUNAS */
        .pdf-body { display: flex; gap: 20px; height: 225mm; } /* Altura fixa para n√£o estourar */
        .col-left { width: 38%; display: flex; flex-direction: column; gap: 20px; }
        .col-right { width: 62%; display: flex; flex-direction: column; gap: 20px; }

        /* CARDS */
        .card { border: 1px solid #f1f2f6; border-radius: 6px; padding: 12px; background: #fff; }
        .card-title { 
            font-size: 8pt; font-weight: 800; text-transform: uppercase; color: #2f3542; 
            border-bottom: 2px solid #f1f2f6; margin-bottom: 10px; padding-bottom: 4px;
        }

        /* 1. GR√ÅFICOS DE ROSCA (CSS PURO - ALTA DEFINI√á√ÉO) */
        .donuts-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; row-gap: 20px; }
        .donut-item { text-align: center; }
        .donut-label { font-size: 7pt; font-weight: 700; text-transform: uppercase; margin-bottom: 5px; color: #747d8c; }
        
        .donut-chart {
            width: 60px; height: 60px; margin: 0 auto; border-radius: 50%;
            position: relative; display: flex; justify-content: center; align-items: center;
            background: #eee; /* Fundo cinza caso falhe */
        }
        /* O miolo branco cria o efeito de rosca */
        .donut-hole { width: 44px; height: 44px; background: white; border-radius: 50%; position: absolute; }
        .donut-val { position: relative; z-index: 2; font-size: 10pt; font-weight: 800; color: #2f3542; }
        .donut-pts { font-size: 6pt; font-weight: 400; display: block; margin-top: -2px; color: #a4b0be; }

        /* 2. ESTILO (HERO) */
        .style-hero { background: #2f3542; color: white; text-align: center; padding: 20px 10px; border-radius: 6px; }
        .style-sub { font-size: 7pt; text-transform: uppercase; letter-spacing: 1px; opacity: 0.8; }
        .style-main { font-size: 18pt; font-weight: 800; margin: 5px 0; text-transform: uppercase; }
        .style-desc { font-size: 7.5pt; font-style: italic; opacity: 0.9; line-height: 1.3; }

        /* 3. LISTAS SENSORIAIS (COMPACTAS) */
        .sensory-group { margin-bottom: 15px; }
        .sensory-title { font-size: 8pt; font-weight: 700; color: #e74c3c; margin-bottom: 6px; text-transform: uppercase; display: flex; align-items: center; gap: 5px; }
        .sensory-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; }
        
        .tag-box { 
            background: #f8f9fa; border-left: 3px solid #ced6e0; border-radius: 3px; 
            padding: 5px 8px; 
        }
        .tag-cat { display: block; font-size: 5.5pt; text-transform: uppercase; color: #a4b0be; font-weight: 700; }
        .tag-opt { display: block; font-size: 7.5pt; font-weight: 600; color: #2f3542; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* CORES TEM√ÅTICAS */
        .bd-fogo { border-color: #ff4757; } .c-fogo { color: #ff4757; }
        .bd-ar { border-color: #1e90ff; } .c-ar { color: #1e90ff; }
        .bd-agua { border-color: #3742fa; } .c-agua { color: #3742fa; }
        .bd-terra { border-color: #2ed573; } .c-terra { color: #2ed573; }

        /* RODAP√â */
        .pdf-footer { 
            position: absolute; bottom: 12mm; left: 15mm; right: 15mm; 
            border-top: 1px solid #dfe4ea; padding-top: 8px; 
            text-align: center; font-size: 6.5pt; color: #a4b0be; 
        }
    </style>
</head>
<body>

    <div class="sys-header">
        <strong>NEUROBRIEFING | Painel Administrativo</strong>
    </div>

    <div class="sys-container">
        <div class="card-lista">
            <h3 style="margin-top:0;">Relat√≥rios Recebidos</h3>
            <p style="font-size:12px; color:#666; margin-bottom:20px;">Use o bot√£o PDF para gerar o relat√≥rio One Page do cliente.</p>
            <table>
                <thead>
                    <tr>
                        <th width="15%">Data</th>
                        <th width="30%">Cliente</th>
                        <th width="20%">Local</th>
                        <th width="20%">Contato</th>
                        <th width="15%" style="text-align: right;">A√ß√£o</th>
                    </tr>
                </thead>
                <tbody id="tabela-corpo">
                    <tr><td colspan="5">Carregando...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <div id="folha-a4">
        
        <div class="pdf-header">
            <div class="brand">
                <h1>NEUROBRIEFING</h1>
                <span>Diagn√≥stico Integral</span>
            </div>
            <div class="meta">
                CLIENTE: <strong id="p-nome">-</strong><br>
                DATA: <span id="p-data">-</span> | LOCAL: <span id="p-local">-</span><br>
                EMAIL: <span id="p-email">-</span>
            </div>
        </div>

        <div class="pdf-body">
            
            <div class="col-left">
                
                <div class="card">
                    <div class="pdf-card-title">1. Perfil Comportamental</div>
                    <div class="donuts-grid">
                        
                        <div class="donut-item">
                            <div class="donut-label c-fogo">Fogo (A√ß√£o)</div>
                            <div class="donut-chart" id="chart-fogo">
                                <div class="donut-hole"></div>
                                <div class="donut-val"><span id="txt-fogo">0</span><span class="donut-pts">%</span></div>
                            </div>
                        </div>

                        <div class="donut-item">
                            <div class="donut-label c-ar">Ar (Ideias)</div>
                            <div class="donut-chart" id="chart-ar">
                                <div class="donut-hole"></div>
                                <div class="donut-val"><span id="txt-ar">0</span><span class="donut-pts">%</span></div>
                            </div>
                        </div>

                        <div class="donut-item">
                            <div class="donut-label c-agua">√Ågua (Emo√ß√£o)</div>
                            <div class="donut-chart" id="chart-agua">
                                <div class="donut-hole"></div>
                                <div class="donut-val"><span id="txt-agua">0</span><span class="donut-pts">%</span></div>
                            </div>
                        </div>

                        <div class="donut-item">
                            <div class="donut-label c-terra">Terra (Ordem)</div>
                            <div class="donut-chart" id="chart-terra">
                                <div class="donut-hole"></div>
                                <div class="donut-val"><span id="txt-terra">0</span><span class="donut-pts">%</span></div>
                            </div>
                        </div>

                    </div>
                </div>

                <div class="card">
                    <div class="pdf-card-title">2. Identidade Est√©tica</div>
                    <div class="style-hero">
                        <div class="style-sub">Estilo Predominante</div>
                        <div id="p-estilo" class="style-main">MODERNO</div>
                        <div id="p-estilo-desc" class="style-desc">...</div>
                    </div>
                </div>

                <div style="font-size: 7pt; color: #666; text-align: justify; padding: 0 5px;">
                    <strong>Nota T√©cnica:</strong> Este perfil foi gerado atrav√©s da an√°lise cruzada de arqu√©tipos naturais e prefer√™ncias visuais subconscientes. Utilize como base para o moodboard.
                </div>

            </div>

            <div class="col-right">
                <div class="card" style="height: 100%;">
                    <div class="pdf-card-title">3. Mapeamento Sensorial & Prefer√™ncias</div>
                    
                    <div class="sensory-group">
                        <div class="sensory-title">üëÅÔ∏è Vis√£o & Espa√ßo</div>
                        <div class="sensory-grid" id="lista-visao"></div>
                    </div>

                    <div class="sensory-group">
                        <div class="sensory-title">‚úã Tato, Som & Olfato</div>
                        <div class="sensory-grid" id="lista-sentidos"></div>
                    </div>

                    <div class="sensory-group">
                        <div class="sensory-title">üå± Lifestyle & Biologia</div>
                        <div class="sensory-grid" id="lista-life"></div>
                    </div>

                </div>
            </div>

        </div>

        <div class="pdf-footer">
            Relat√≥rio gerado automaticamente pela plataforma NeuroBriefing Intelligence. Documento confidencial. ¬© 2026
        </div>
    </div>

    <script>
        let todosDados = [];

        async function init() {
            try {
                // Carrega dados da sua API
                const req = await fetch('/api/relatorios');
                todosDados = await req.json();
                renderTabela();
            } catch(e) { console.error(e); }
        }

        function renderTabela() {
            const tbody = document.getElementById('tabela-corpo');
            tbody.innerHTML = '';
            [...todosDados].reverse().forEach((d, i) => {
                const iReal = todosDados.length - 1 - i;
                tbody.innerHTML += `
                    <tr>
                        <td>${new Date(d.data).toLocaleDateString()}</td>
                        <td><strong>${d.cliente}</strong></td>
                        <td>${d.contato?.cidade || '-'}</td>
                        <td>${d.contato?.email || '-'}</td>
                        <td style="text-align: right;">
                            <button class="btn-pdf" onclick="gerarPDF(${iReal}, this)">üìÑ PDF</button>
                        </td>
                    </tr>
                `;
            });
        }

        // --- C√âREBRO DA GERA√á√ÉO DO PDF ---
        async function gerarPDF(index, btn) {
            const dados = todosDados[index];
            if(!dados) return;

            const txtOriginal = btn.innerText;
            btn.innerText = "‚è≥ ..."; btn.disabled = true;

            // 1. MATEM√ÅTICA CORRETA (Soma Num√©rica)
            let pts = { FOGO:0, AR:0, AGUA:0, TERRA:0 };
            let estilo = "Em An√°lise";
            
            // Arrays para as listas
            let grpVisao = [], grpSentidos = [], grpLife = [];

            const resp = dados.respostas || {};

            Object.keys(resp).forEach(key => {
                // CORRE√á√ÉO CR√çTICA: parseInt garante que "5" + "15" seja 20, n√£o 515
                let val = parseInt(resp[key], 10) || 0;

                // Soma Perfil
                if(key.includes('fogo')) pts.FOGO += val;
                if(key.includes('ar')) pts.AR += val;
                if(key.includes('agua')) pts.AGUA += val;
                if(key.includes('terra')) pts.TERRA += val;

                // Estilo
                if(key.includes('arq_1') && val > 0) estilo = key.split('::')[1];

                // Organiza Tags (Listas)
                if(key.includes('::') && val > 0 && !key.includes('arq_1')) {
                    const [catRaw, opt] = key.split('::');
                    // Limpa nomes longos
                    let cat = catRaw.replace('SENSORIAL: ', '').replace('PSICOLOGIA DAS ', '').replace('CONEX√ÉO COM A ', '');
                    if(cat === 'AUDI√á√ÉO') cat = 'AC√öSTICA';
                    if(cat === 'BIOL√ìGICO/T√âRMICO') cat = 'CONF. T√âRMICO';

                    const item = { cat, opt };

                    // Distribui nas categorias visuais
                    if(['ILUMINA√á√ÉO','CORES','FORMAS','BIOFILIA', 'NATUREZA'].some(x=>cat.includes(x))) grpVisao.push(item);
                    else if(['TATO','AC√öSTICA','MEM√ìRIA OLFATIVA','AROMAS', 'PALADAR', 'GOURMET'].some(x=>cat.includes(x))) grpSentidos.push(item);
                    else grpLife.push(item);
                }
            });

            // 2. PREENCHER DADOS NO HTML
            document.getElementById('p-nome').innerText = dados.cliente;
            document.getElementById('p-data').innerText = new Date(dados.data).toLocaleString();
            document.getElementById('p-local').innerText = `${dados.contato?.cidade || ''} - ${dados.contato?.estado || ''}`;
            document.getElementById('p-email').innerText = dados.contato?.email || '-';

            // --- GR√ÅFICOS DE ROSCA (CSS Conic Gradient) ---
            const max = 25; // Pontua√ß√£o m√°xima
            
            // Fun√ß√£o para desenhar a rosca via CSS
            const setDonut = (elemId, txtId, val, color) => {
                const pct = Math.round((val / max) * 100);
                const chart = document.getElementById(elemId);
                // O "Segredo" do gr√°fico bonito:
                chart.style.background = `conic-gradient(${color} ${pct}%, #ecf0f1 0deg)`;
                document.getElementById(txtId).innerText = pct;
            };

            setDonut('chart-fogo', 'txt-fogo', pts.FOGO, '#ff4757');
            setDonut('chart-ar', 'txt-ar', pts.AR, '#1e90ff');
            setDonut('chart-agua', 'txt-agua', pts.AGUA, '#3742fa');
            setDonut('chart-terra', 'txt-terra', pts.TERRA, '#2ed573');

            // ESTILO
            document.getElementById('p-estilo').innerText = estilo.toUpperCase();
            setDesc(estilo);

            // LISTAS
            const renderLista = (arr, elId, colorCls) => {
                const el = document.getElementById(elId);
                el.innerHTML = '';
                arr.forEach(i => {
                    el.innerHTML += `
                    <div class="tag-box ${colorCls}">
                        <span class="tag-cat">${i.cat}</span>
                        <span class="tag-opt">${i.opt}</span>
                    </div>`;
                });
            };

            renderLista(grpVisao, 'lista-visao', 'bd-fogo');
            renderLista(grpSentidos, 'lista-sentidos', 'bd-agua');
            renderLista(grpLife, 'lista-life', 'bd-terra');

            // 3. GERAR PDF
            const element = document.getElementById('folha-a4');
            element.style.display = 'block'; // Mostra

            const opt = {
                margin: 0,
                filename: `NeuroBriefing_${dados.cliente}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, useCORS: true }, // Alta Resolu√ß√£o
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };

            await html2pdf().set(opt).from(element).save();

            // Reseta
            element.style.display = 'none';
            btn.innerText = txtOriginal;
            btn.disabled = false;
        }

        function setDesc(est) {
            const map = {
                'Moderno': 'Funcionalidade, linhas retas e clareza visual. Ambientes limpos.',
                'Cl√°ssico': 'Simetria e nobreza. Valoriza a hist√≥ria, ornamentos e sofistica√ß√£o.',
                'Industrial': 'Urbano, metais e concreto aparente. Est√©tica jovem e estrutural.',
                'R√∫stico': 'Madeira bruta e texturas naturais. Foca no acolhimento e calor.',
                'Natural': 'Biofilia, luz natural e ventila√ß√£o. Ambientes que respiram vida.'
            };
            document.getElementById('p-estilo-desc').innerText = map[est] || 'Perfil √önico.';
        }

        init();
    </script>
</body>
</html>