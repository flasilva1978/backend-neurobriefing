<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dossi√™ NeuroBriefing</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        /* --- RESET --- */
        * { box-sizing: border-box; -webkit-print-color-adjust: exact; }
        body { font-family: 'Montserrat', sans-serif; background: #e0e5ec; margin: 0; padding: 20px; color: #333; }
        
        /* Painel de Controle (N√£o sai no PDF) */
        .painel { max-width: 1000px; margin: 0 auto 30px auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .header-painel { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding-bottom: 15px; margin-bottom: 15px; }
        .btn { background: #1a1a1a; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; font-weight: 600; text-transform: uppercase; font-size: 9pt; letter-spacing: 1px; }
        table { width: 100%; border-collapse: collapse; font-size: 10pt; }
        th { text-align: left; padding: 10px; background: #f4f4f4; color: #333; font-weight: 700; }
        td { padding: 10px; border-bottom: 1px solid #eee; }

        /* --- ESTRUTURA DO PDF (A4 R√çGIDO) --- */
        #relatorio-pdf { display: none; }
        
        .page { 
            width: 210mm; 
            height: 297mm; /* Altura A4 exata */
            background: white; 
            position: relative; 
            overflow: hidden; 
            page-break-after: always;
            margin: 0 auto;
            padding: 0;
        }
        .page:last-child { page-break-after: auto; }

        /* --- P√ÅGINA 1: CAPA (Design Minimalista) --- */
        .capa-wrapper {
            height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center;
            background: #fff; padding: 20mm; text-align: center; border: 15mm solid #f8f9fa;
        }
        .capa-logo { font-size: 36pt; font-weight: 900; letter-spacing: -1px; color: #1a1a1a; margin-bottom: 5px; }
        .capa-tagline { font-size: 9pt; letter-spacing: 4px; text-transform: uppercase; color: #999; margin-bottom: 60px; }
        
        .capa-data-box { width: 100%; border-top: 1px solid #ddd; border-bottom: 1px solid #ddd; padding: 30px 0; margin-bottom: 40px; }
        .cd-row { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 10pt; }
        .cd-row:last-child { margin-bottom: 0; }
        .cd-lbl { font-weight: 700; color: #999; text-transform: uppercase; font-size: 8pt; letter-spacing: 1px; }
        .cd-val { font-weight: 600; color: #333; text-align: right; }

        .capa-footer { font-size: 7pt; color: #ccc; text-transform: uppercase; letter-spacing: 2px; position: absolute; bottom: 20mm; }

        /* --- P√ÅGINA 2: M√ìDULO 1 (Layout Compacto) --- */
        .mod-wrapper { padding: 15mm 15mm 10mm 15mm; height: 100%; display: flex; flex-direction: column; }
        
        /* Cabe√ßalho Modulo */
        .mod-head { border-bottom: 4px solid #1a1a1a; padding-bottom: 10px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: flex-end; }
        .mh-left h1 { margin: 0; font-size: 24pt; font-weight: 800; color: #1a1a1a; line-height: 1; }
        .mh-left span { font-size: 8pt; text-transform: uppercase; color: #777; letter-spacing: 1px; font-weight: 600; }
        .mh-right { font-size: 30pt; color: #eee; font-weight: 900; line-height: 0.8; }

        /* Barras de Perfil (Compactas) */
        .perf-grid { display: flex; gap: 10px; margin-bottom: 25px; height: 60px; }
        .perf-card { flex: 1; border: 1px solid #eee; border-radius: 4px; padding: 8px; display: flex; flex-direction: column; justify-content: space-between; }
        .pc-top { display: flex; justify-content: space-between; align-items: center; }
        .pc-lbl { font-size: 8pt; font-weight: 800; text-transform: uppercase; }
        .pc-val { font-size: 12pt; font-weight: 900; }
        .pc-bar-bg { width: 100%; height: 6px; background: #f0f0f0; border-radius: 3px; overflow: hidden; }
        .pc-bar-fill { height: 100%; border-radius: 3px; }

        /* RESULTADO PRINCIPAL (O grande destaque) */
        .main-result { 
            flex: 1; border: 1px solid #ddd; border-radius: 8px; overflow: hidden; display: flex; flex-direction: column; 
            margin-bottom: 20px; background: #fff;
        }
        .mr-header { padding: 15px 20px; color: white; display: flex; justify-content: space-between; align-items: center; }
        .mr-title { font-size: 16pt; font-weight: 800; text-transform: uppercase; }
        .mr-sub { font-size: 9pt; font-weight: 600; opacity: 0.9; text-transform: uppercase; letter-spacing: 1px; }

        .mr-content { display: flex; flex: 1; }
        .mr-col { padding: 20px; width: 50%; }
        .mr-left { border-right: 1px dashed #eee; }
        
        /* Lista de Detalhes */
        .det-item { margin-bottom: 15px; }
        .det-lbl { font-size: 7pt; font-weight: 700; color: #999; text-transform: uppercase; display: block; margin-bottom: 3px; letter-spacing: 0.5px; }
        .det-val { font-size: 10pt; font-weight: 600; color: #333; line-height: 1.3; }

        .feat-title { font-size: 9pt; font-weight: 800; color: #1a1a1a; text-transform: uppercase; margin-bottom: 8px; border-bottom: 1px solid #eee; padding-bottom: 3px; }
        .feat-list { list-style: none; padding: 0; margin: 0 0 20px 0; }
        .feat-list li { font-size: 8.5pt; color: #555; margin-bottom: 4px; padding-left: 12px; position: relative; }
        .feat-list li::before { content: "‚ñ™"; color: #ccc; position: absolute; left: 0; }

        /* Rodap√© com Ranking */
        .rank-box { background: #f9f9f9; border: 1px solid #eee; border-radius: 6px; padding: 15px; display: flex; gap: 20px; }
        .rank-col { flex: 1; }
        .rk-head { font-size: 8pt; font-weight: 800; color: #1a1a1a; text-transform: uppercase; margin-bottom: 5px; }
        .rk-row { display: flex; justify-content: space-between; font-size: 9pt; margin-bottom: 3px; border-bottom: 1px dashed #e0e0e0; padding-bottom: 3px; }
        .rk-row:last-child { border: none; }
        .rk-n { font-weight: 700; color: #333; }
        .rk-d { color: #777; font-size: 8pt; font-style: italic; }

        .footer-note { margin-top: auto; text-align: center; font-size: 7pt; color: #aaa; border-top: 1px solid #eee; padding-top: 8px; }

        /* Cores Elementais */
        .c-fogo { color: #e74c3c; } .bg-fogo { background: #e74c3c; }
        .c-ar { color: #3498db; } .bg-ar { background: #3498db; }
        .c-agua { color: #2980b9; } .bg-agua { background: #2980b9; }
        .c-terra { color: #27ae60; } .bg-terra { background: #27ae60; }

    </style>
</head>
<body>

    <div class="painel">
        <div class="header-painel">
            <div>
                <h2 style="margin:0; font-weight:800;">NEUROBRIEFING | DASHBOARD</h2>
                <span style="font-size:9pt; color:#888;">Controle de Relat√≥rios</span>
            </div>
            <button class="btn" onclick="location.reload()">Atualizar</button>
        </div>
        <table>
            <thead><tr><th>Data</th><th>Cliente</th><th>Status</th><th style="text-align:right">Op√ß√µes</th></tr></thead>
            <tbody id="lista"><tr><td colspan="4">Carregando...</td></tr></tbody>
        </table>
    </div>

    <div id="relatorio-pdf">
        
        <div class="page">
            <div class="capa-wrapper">
                <div class="capa-logo">NEUROBRIEFING</div>
                <div class="capa-tagline">Diagn√≥stico Integral & Estrat√©gia</div>
                
                <div class="capa-data-box">
                    <div class="cd-row">
                        <span class="cd-lbl">Cliente Analisado</span>
                        <span class="cd-val" id="capa-nome">-</span>
                    </div>
                    <div class="cd-row">
                        <span class="cd-lbl">Arquiteto Respons√°vel</span>
                        <span class="cd-val" id="capa-arq">-</span>
                    </div>
                    <div class="cd-row">
                        <span class="cd-lbl">Data do Dossi√™</span>
                        <span class="cd-val" id="capa-data">-</span>
                    </div>
                </div>

                <div class="capa-footer">Documento Confidencial ‚Ä¢ Uso Profissional</div>
            </div>
        </div>

        <div class="page">
            <div class="mod-wrapper">
                
                <div class="mod-head">
                    <div class="mh-left">
                        <h1>IDENTIDADE DO SER</h1>
                        <span>Mapeamento de Arqu√©tipo & Temperamento</span>
                    </div>
                    <div class="mh-right">01</div>
                </div>

                <div class="perf-grid">
                    <div class="perf-card">
                        <div class="pc-top"><span class="pc-lbl c-fogo">Fogo</span><span class="pc-val c-fogo" id="v-fogo">0</span></div>
                        <div class="pc-bar-bg"><div class="pc-bar-fill bg-fogo" id="b-fogo"></div></div>
                    </div>
                    <div class="perf-card">
                        <div class="pc-top"><span class="pc-lbl c-ar">Ar</span><span class="pc-val c-ar" id="v-ar">0</span></div>
                        <div class="pc-bar-bg"><div class="pc-bar-fill bg-ar" id="b-ar"></div></div>
                    </div>
                    <div class="perf-card">
                        <div class="pc-top"><span class="pc-lbl c-agua">√Ågua</span><span class="pc-val c-agua" id="v-agua">0</span></div>
                        <div class="pc-bar-bg"><div class="pc-bar-fill bg-agua" id="b-agua"></div></div>
                    </div>
                    <div class="perf-card">
                        <div class="pc-top"><span class="pc-lbl c-terra">Terra</span><span class="pc-val c-terra" id="v-terra">0</span></div>
                        <div class="pc-bar-bg"><div class="pc-bar-fill bg-terra" id="b-terra"></div></div>
                    </div>
                </div>

                <div class="main-result">
                    <div class="mr-header" id="mr-header">
                        <div class="mr-title" id="txt-elemento">ELEMENTO -</div>
                        <div class="mr-sub" id="txt-estilo">-</div>
                    </div>
                    
                    <div class="mr-content">
                        <div class="mr-col mr-left">
                            <div class="det-item">
                                <span class="det-lbl">‚ö° Energia</span>
                                <div class="det-val" id="txt-energia">-</div>
                            </div>
                            <div class="det-item">
                                <span class="det-lbl">üë§ Para Quem</span>
                                <div class="det-val" id="txt-quem">-</div>
                            </div>
                            <div style="display:flex; gap:15px;">
                                <div class="det-item" style="flex:1;">
                                    <span class="det-lbl">üìã Perfil</span>
                                    <div class="det-val" id="txt-perfil">-</div>
                                </div>
                                <div class="det-item" style="flex:1;">
                                    <span class="det-lbl">üß¨ Temperamento</span>
                                    <div class="det-val" id="txt-temp">-</div>
                                </div>
                            </div>
                            <div class="det-item">
                                <span class="det-lbl">üé≠ Arqu√©tipos</span>
                                <div class="det-val" id="txt-arq">-</div>
                            </div>
                        </div>

                        <div class="mr-col">
                            <div class="feat-title">üè† Estilos Inclu√≠dos</div>
                            <ul class="feat-list" id="list-estilos"></ul>

                            <div class="feat-title">‚ú® Caracter√≠sticas</div>
                            <ul class="feat-list" id="list-carac"></ul>
                        </div>
                    </div>
                </div>

                <div class="rank-box">
                    <div class="rank-col">
                        <div class="rk-head">Leitura do Diagn√≥stico</div>
                        <div class="rk-row">
                            <span class="rk-n">1Ô∏è‚É£ Dominante <span id="r-dom"></span></span>
                            <span class="rk-d">Energia atual</span>
                        </div>
                        <div class="rk-row">
                            <span class="rk-n">2Ô∏è‚É£ Secund√°rio <span id="r-sec"></span></span>
                            <span class="rk-d">Recurso</span>
                        </div>
                        <div class="rk-row">
                            <span class="rk-n">3Ô∏è‚É£ Menos Acessado <span id="r-last"></span></span>
                            <span class="rk-d">A desenvolver</span>
                        </div>
                    </div>
                    <div class="rank-col" style="border-left:1px solid #ddd; padding-left:20px; display:flex; align-items:center;">
                        <div style="font-size:8pt; color:#666; font-style:italic; line-height:1.5;">
                            "Voc√™ n√£o √© um tipo fixo. Voc√™ √© um sistema vivo em equil√≠brio din√¢mico. A neuroarquitetura busca harmonizar sua natureza com o espa√ßo."
                        </div>
                    </div>
                </div>

                <div class="footer-note">
                    Relat√≥rio gerado pela plataforma NeuroBriefing Intelligence
                </div>

            </div>
        </div>

    </div>

    <script>
        // DADOS RICOS
        const DB = {
            FOGO: {
                cor: '#e74c3c',
                titulo: 'ESTILOS DE ATIVA√á√ÉO',
                energia: 'A√ß√£o ¬∑ Dire√ß√£o ¬∑ Intensidade',
                quem: 'Pessoas executor-col√©ricas, a√ß√£o',
                perfil: 'Executor',
                temp: 'Col√©rico',
                arq: 'Her√≥i ¬∑ Governante ¬∑ Fora-da-Lei',
                estilos: ['Contempor√¢neo', 'Industrial', 'Moderno Urbano', 'High Tech', 'Luxo Moderno'],
                carac: ['Contrastes marcantes', 'Linhas retas definidas', 'Materiais fortes (metal, couro)', 'Ilumina√ß√£o direcionada', 'Paleta profunda']
            },
            AR: {
                cor: '#3498db',
                titulo: 'ESTILOS DE EXPRESS√ÉO',
                energia: 'Express√£o ¬∑ Conex√£o ¬∑ Movimento',
                quem: 'Comunicador-sangu√≠neo, relacionais',
                perfil: 'Comunicador',
                temp: 'Sangu√≠neo',
                arq: 'Amante ¬∑ Bobo da Corte ¬∑ Explorador',
                estilos: ['Escandinavo', 'Contempor√¢neo Leve', 'Mid-Century Modern', 'Boho Chic', 'Ecl√©tico'],
                carac: ['Luz natural abundante', 'Layout fluido e aberto', 'Mistura criativa', 'Cores claras vibrantes', 'Sensa√ß√£o de liberdade']
            },
            AGUA: {
                cor: '#2980b9',
                titulo: 'ESTILOS DE ACOLHIMENTO',
                energia: 'Sensibilidade ¬∑ Adapta√ß√£o ¬∑ Ritmo',
                quem: 'Planejador-fleum√°tico, cuidado',
                perfil: 'Planejador',
                temp: 'Fleum√°tico',
                arq: 'Cuidador ¬∑ Inocente ¬∑ Mago',
                estilos: ['Japandi', 'Org√¢nico Contempor√¢neo', 'Wabi-Sabi', 'Coastal Sofisticado', 'Natural Chic'],
                carac: ['Texturas suaves e t√°teis', 'Paleta neutra quente', 'Materiais naturais (linho, madeira)', 'Ilumina√ß√£o difusa', 'Ambientes calmos']
            },
            TERRA: {
                cor: '#27ae60',
                titulo: 'ESTILOS DE ESTRUTURA',
                energia: 'Estrutura ¬∑ Profundidade ¬∑ Const√¢ncia',
                quem: 'Analista-melanc√≥lico, sabedoria',
                perfil: 'Analista',
                temp: 'Melanc√≥lico',
                arq: 'S√°bio ¬∑ Criador ¬∑ √ìrf√£o',
                estilos: ['Cl√°ssico Atemporal', 'Neocl√°ssico', 'Tradicional', 'Moderno Elegante', 'Colonial Atualizado'],
                carac: ['Propor√ß√£o e simetria', 'Materiais nobres/dur√°veis', 'Paleta s√≥bria e profunda', 'Organiza√ß√£o visual', 'Sensa√ß√£o de perman√™ncia']
            }
        };

        let dadosAPI = [];

        async function init() {
            try {
                const req = await fetch('https://api-neurobriefing.onrender.com/api/relatorios');
                dadosAPI = await req.json();
                renderTable();
            } catch(e) { console.error(e); }
        }

        function renderTable() {
            const tbody = document.getElementById('lista');
            tbody.innerHTML = '';
            [...dadosAPI].reverse().forEach((d, i) => {
                const idx = dadosAPI.length - 1 - i;
                tbody.innerHTML += `<tr>
                    <td>${new Date(d.data).toLocaleDateString()}</td>
                    <td><strong>${d.cliente}</strong></td>
                    <td><span style="color:#27ae60; font-weight:700;">Recebido</span></td>
                    <td style="text-align:right"><button class="btn" onclick="gerarPDF(${idx}, this)">PDF</button></td>
                </tr>`;
            });
        }

        async function gerarPDF(index, btn) {
            const dados = dadosAPI[index];
            const originalTxt = btn.innerText; btn.innerText = "..."; btn.disabled = true;

            // 1. CAPA
            document.getElementById('capa-nome').innerText = dados.cliente;
            document.getElementById('capa-arq').innerText = dados.contato?.arquiteto || '-';
            document.getElementById('capa-data').innerText = new Date(dados.data).toLocaleDateString();

            // 2. M√ìDULO 1
            let pts = { FOGO:0, AR:0, AGUA:0, TERRA:0 };
            const resp = dados.respostas || {};
            
            Object.keys(resp).forEach(k => {
                let val = parseInt(resp[k], 10) || 0;
                if(k.includes('fogo')) pts.FOGO += val;
                if(k.includes('ar')) pts.AR += val;
                if(k.includes('agua')) pts.AGUA += val;
                if(k.includes('terra')) pts.TERRA += val;
            });

            // Ordena√ß√£o
            const sorted = [
                { id: 'FOGO', val: pts.FOGO, ...DB.FOGO },
                { id: 'AR', val: pts.AR, ...DB.AR },
                { id: 'AGUA', val: pts.AGUA, ...DB.AGUA },
                { id: 'TERRA', val: pts.TERRA, ...DB.TERRA }
            ].sort((a,b) => b.val - a.val);

            const dom = sorted[0];
            const sec = sorted[1];
            const last = sorted[3];

            // Barras
            ['FOGO','AR','AGUA','TERRA'].forEach(key => {
                const kLower = key.toLowerCase();
                const score = pts[key];
                document.getElementById(`v-${kLower}`).innerText = score;
                document.getElementById(`b-${kLower}`).style.width = Math.min((score/25)*100, 100) + '%';
            });

            // Box Principal
            const header = document.getElementById('mr-header');
            header.style.backgroundColor = dom.cor;
            document.getElementById('txt-elemento').innerText = `ELEMENTO ${dom.id}`;
            document.getElementById('txt-estilo').innerText = dom.titulo;

            // Textos
            document.getElementById('txt-energia').innerText = dom.energia;
            document.getElementById('txt-quem').innerText = dom.quem;
            document.getElementById('txt-perfil').innerText = dom.perfil;
            document.getElementById('txt-temp').innerText = dom.temp;
            document.getElementById('txt-arq').innerText = dom.arq;

            // Listas
            document.getElementById('list-estilos').innerHTML = dom.estilos.map(x => `<li>${x}</li>`).join('');
            document.getElementById('list-carac').innerHTML = dom.carac.map(x => `<li>${x}</li>`).join('');

            // Ranking
            document.getElementById('r-dom').innerText = `${dom.id} (${dom.val})`;
            document.getElementById('r-sec').innerText = `${sec.id} (${sec.val})`;
            document.getElementById('r-last').innerText = `${last.id} (${last.val})`;

            // 3. EXPORTAR
            const element = document.getElementById('relatorio-pdf');
            element.style.display = 'block';

            setTimeout(async () => {
                const opt = {
                    margin: 0, // Margem ZERO para o HTML controlar tudo
                    filename: `Dossie_${dados.cliente}.pdf`,
                    image: { type: 'jpeg', quality: 0.98 },
                    html2canvas: { scale: 2, useCORS: true },
                    jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
                };
                await html2pdf().set(opt).from(element).save();
                
                element.style.display = 'none';
                btn.innerText = originalTxt; btn.disabled = false;
            }, 500);
        }

        init();
    </script>
</body>
</html>