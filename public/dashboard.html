<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel NeuroBriefing Pro</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;700;800&display=swap" rel="stylesheet">
    
    <style>
        /* --- SISTEMA (TELA) --- */
        body { font-family: 'Segoe UI', sans-serif; background: #eaeff2; margin: 0; color: #333; }
        .sys-header { background: #1e272e; padding: 15px; color: #fff; text-align: center; }
        .sys-container { max-width: 1200px; margin: 20px auto; padding: 20px; }
        .card-table { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        
        table { width: 100%; border-collapse: collapse; font-size: 13px; margin-top: 15px; }
        th { background: #f1f2f6; text-align: left; padding: 10px; border-bottom: 2px solid #ccc; }
        td { padding: 10px; border-bottom: 1px solid #eee; }
        
        .btn-pdf { background: #ff4757; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-weight: bold; }
        .btn-pdf:hover { background: #ff6b81; }

        /* --- PDF ONE PAGE (LAYOUT A4 RIGOROSO) --- */
        #folha-a4 {
            width: 210mm; height: 296mm; /* A4 Exato */
            background: white; margin: 50px auto; padding: 10mm 12mm;
            box-sizing: border-box; display: none; position: relative;
            font-family: 'Montserrat', sans-serif; color: #2f3542;
            overflow: hidden;
        }

        /* 1. HEADER */
        .header { display: flex; justify-content: space-between; border-bottom: 3px solid #2f3542; padding-bottom: 8px; margin-bottom: 15px; }
        .brand h1 { margin: 0; font-size: 20pt; font-weight: 900; letter-spacing: -1px; line-height: 1; }
        .brand span { font-size: 7pt; letter-spacing: 2px; text-transform: uppercase; color: #7f8c8d; }
        .client-info { text-align: right; font-size: 7.5pt; line-height: 1.3; color: #57606f; }
        .client-info strong { color: #000; font-size: 9pt; }

        /* 2. PERFIL (BARRAS + SCORES) */
        .sec-header { 
            background: #2f3542; color: white; padding: 4px 8px; 
            font-size: 8pt; font-weight: 700; text-transform: uppercase; 
            margin-bottom: 8px; display: flex; justify-content: space-between;
        }
        .scale-info { font-size: 6pt; font-weight: 400; opacity: 0.8; text-transform: none; }

        .profile-row { display: flex; gap: 10px; margin-bottom: 15px; }
        .profile-card { 
            flex: 1; border: 1px solid #dfe4ea; border-radius: 4px; padding: 8px; text-align: center; 
            position: relative; background: #fff;
        }
        
        /* Destaque Predominante */
        .predominante { border: 2px solid #f1c40f; background: #fffdf0; }
        .badge-pred { 
            position: absolute; top: -6px; left: 50%; transform: translateX(-50%); 
            background: #f1c40f; color: #000; font-size: 5pt; font-weight: 800; 
            padding: 2px 6px; border-radius: 3px; text-transform: uppercase; display: none;
        }
        .predominante .badge-pred { display: block; }

        .pc-title { font-size: 7pt; font-weight: 800; text-transform: uppercase; margin-bottom: 5px; display: block; }
        .pc-score { font-size: 16pt; font-weight: 900; line-height: 1; margin-bottom: 5px; display: block; }
        
        /* Barra de Progresso */
        .pc-bar-bg { width: 80%; height: 6px; background: #eee; margin: 0 auto; border-radius: 3px; overflow: hidden; }
        .pc-bar-fill { height: 100%; border-radius: 3px; }

        /* 3. ESTILO (BANNER) */
        .style-row { 
            display: flex; align-items: center; justify-content: space-between; 
            background: #f1f2f6; border-left: 5px solid #2f3542; padding: 10px 15px; margin-bottom: 15px; 
        }
        .style-name { font-size: 18pt; font-weight: 900; text-transform: uppercase; line-height: 1; color: #2f3542; }
        .style-desc { width: 60%; font-size: 7.5pt; font-style: italic; text-align: right; color: #57606f; }

        /* 4. SENSORIAL (GRID DE DONUTS - 5 Colunas) */
        .sensory-grid { 
            display: grid; grid-template-columns: repeat(5, 1fr); 
            gap: 10px; row-gap: 15px; margin-bottom: 15px; 
        }
        .donut-card { text-align: center; }
        .dc-title { 
            font-size: 6pt; font-weight: 700; color: #a4b0be; text-transform: uppercase; 
            margin-bottom: 5px; white-space: nowrap; overflow: hidden; border-bottom: 1px solid #f1f2f6;
        }
        
        /* O Gráfico CSS (Vector Quality) */
        .donut { 
            width: 36px; height: 36px; margin: 0 auto; border-radius: 50%; 
            position: relative; display: flex; justify-content: center; align-items: center;
            background: #eee;
        }
        .donut-hole { width: 24px; height: 24px; background: white; border-radius: 50%; position: absolute; }
        
        /* Legenda das Porcentagens */
        .dc-legend { margin-top: 4px; text-align: left; padding-left: 2px; }
        .dc-row { display: flex; align-items: center; margin-bottom: 1px; }
        .dc-dot { width: 4px; height: 4px; border-radius: 50%; margin-right: 3px; flex-shrink: 0; }
        .dc-txt { font-size: 5pt; color: #2f3542; font-weight: 600; line-height: 1; white-space: nowrap; }

        /* 5. LIFESTYLE (GRID DE TAGS) */
        .life-grid { 
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; 
        }
        .life-col { border-top: 1px solid #ccc; padding-top: 5px; }
        .life-head { font-size: 6.5pt; font-weight: 800; color: #e74c3c; text-transform: uppercase; margin-bottom: 4px; display: block; }
        .life-item { 
            font-size: 6pt; color: #333; background: #fff; border: 1px solid #eee; 
            padding: 3px 5px; margin-bottom: 3px; display: block; border-radius: 3px;
        }

        /* CORES */
        .c-fogo { color: #ff4757; } .bg-fogo { background: #ff4757; }
        .c-ar { color: #1e90ff; } .bg-ar { background: #1e90ff; }
        .c-agua { color: #3742fa; } .bg-agua { background: #3742fa; }
        .c-terra { color: #2ed573; } .bg-terra { background: #2ed573; }

        /* FOOTER */
        .footer { 
            position: absolute; bottom: 8mm; left: 12mm; right: 12mm; 
            border-top: 1px solid #eee; padding-top: 6px; 
            text-align: center; font-size: 6pt; color: #ccc; 
        }
    </style>
</head>
<body>

    <div class="sys-header">
        <strong>NEUROBRIEFING | Admin</strong>
        <button class="btn-pdf" onclick="location.reload()" style="background:#333;">Atualizar</button>
    </div>

    <div class="sys-container">
        <div class="card-table">
            <h3>Relatórios Recebidos</h3>
            <table>
                <thead>
                    <tr>
                        <th width="15%">Data</th>
                        <th width="25%">Cliente</th>
                        <th width="20%">Email</th>
                        <th width="15%">Celular</th>
                        <th width="15%">Local</th>
                        <th width="10%" style="text-align:right">Ação</th>
                    </tr>
                </thead>
                <tbody id="lista">
                    <tr><td colspan="6">Carregando...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <div id="folha-a4">
        
        <div class="header">
            <div class="brand">
                <h1>NEUROBRIEFING</h1>
                <span>Diagnóstico de Neuroarquitetura</span>
            </div>
            <div class="client-info">
                CLIENTE: <strong id="p-nome">-</strong><br>
                DATA: <span id="p-data">-</span> | LOCAL: <span id="p-local">-</span><br>
                EMAIL: <span id="p-email">-</span> | TEL: <span id="p-tel">-</span>
            </div>
        </div>

        <div class="sec-header">
            1. Perfil Comportamental (Arquétipo)
            <span class="scale-info">Escala de 0 a 25 pontos (Máximo)</span>
        </div>
        <div class="profile-row">
            <div class="profile-card" id="card-fogo">
                <span class="badge-pred">Predominante</span>
                <span class="pc-title c-fogo">Fogo</span>
                <span class="pc-score c-fogo" id="val-fogo">0</span>
                <div class="pc-bar-bg"><div class="pc-bar-fill bg-fogo" id="bar-fogo"></div></div>
            </div>
            <div class="profile-card" id="card-ar">
                <span class="badge-pred">Predominante</span>
                <span class="pc-title c-ar">Ar</span>
                <span class="pc-score c-ar" id="val-ar">0</span>
                <div class="pc-bar-bg"><div class="pc-bar-fill bg-ar" id="bar-ar"></div></div>
            </div>
            <div class="profile-card" id="card-agua">
                <span class="badge-pred">Predominante</span>
                <span class="pc-title c-agua">Água</span>
                <span class="pc-score c-agua" id="val-agua">0</span>
                <div class="pc-bar-bg"><div class="pc-bar-fill bg-agua" id="bar-agua"></div></div>
            </div>
            <div class="profile-card" id="card-terra">
                <span class="badge-pred">Predominante</span>
                <span class="pc-title c-terra">Terra</span>
                <span class="pc-score c-terra" id="val-terra">0</span>
                <div class="pc-bar-bg"><div class="pc-bar-fill bg-terra" id="bar-terra"></div></div>
            </div>
        </div>

        <div class="sec-header">2. Identidade Visual Predominante</div>
        <div class="style-row">
            <div class="style-name" id="p-estilo">EM ANÁLISE</div>
            <div class="style-desc" id="p-estilo-desc">...</div>
        </div>

        <div class="sec-header">3. Mapeamento Sensorial & Preferências</div>
        <div class="sensory-grid" id="grid-sensorial">
            </div>

        <div class="sec-header">4. Lifestyle & Estratégia</div>
        <div class="life-grid">
            <div class="life-col">
                <span class="life-head">Social & Família</span>
                <div id="life-social"></div>
            </div>
            <div class="life-col">
                <span class="life-head">Hobbies & Pessoal</span>
                <div id="life-hobbies"></div>
            </div>
            <div class="life-col">
                <span class="life-head">Investimento & Uso</span>
                <div id="life-invest"></div>
            </div>
        </div>

        <div class="footer">Relatório gerado via NeuroBriefing Intelligence. Uso Profissional.</div>
    </div>

    <script>
        let dadosAPI = [];
        // Paleta de cores para os Donuts (igual ao seu modelo)
        const PALETA = ['#3498db', '#e74c3c', '#f1c40f', '#2ecc71', '#9b59b6'];

        async function init() {
            try {
                const req = await fetch('/api/relatorios');
                dadosAPI = await req.json();
                renderTable();
            } catch(e) { console.error(e); }
        }

        function renderTable() {
            const tbody = document.getElementById('lista');
            tbody.innerHTML = '';
            [...dadosAPI].reverse().forEach((d, i) => {
                const idx = dadosAPI.length - 1 - i;
                tbody.innerHTML += `
                    <tr>
                        <td>${new Date(d.data).toLocaleDateString()}</td>
                        <td><strong>${d.cliente}</strong></td>
                        <td>${d.contato?.email || '-'}</td>
                        <td>${d.contato?.telefone || '-'}</td>
                        <td>${d.contato?.cidade || '-'}</td>
                        <td style="text-align:right"><button class="btn-pdf" onclick="gerarPDF(${idx}, this)">PDF</button></td>
                    </tr>`;
            });
        }

        async function gerarPDF(index, btn) {
            const dados = dadosAPI[index];
            if(!dados) return;
            const originalText = btn.innerText; btn.innerText = "⏳"; btn.disabled = true;

            // --- 1. PROCESSAMENTO DE DADOS ---
            let pts = { FOGO:0, AR:0, AGUA:0, TERRA:0 };
            let estilo = "Em Análise";
            let visualGroups = {}; // Agrupa (Ex: Iluminação: [{Quente:50}, {Fria:50}])
            let lifeGroups = { social:[], hobbies:[], invest:[] };

            const resp = dados.respostas || {};

            Object.keys(resp).forEach(k => {
                // CORREÇÃO MATEMÁTICA: parseInt garante número.
                let val = parseInt(resp[k], 10) || 0;

                // Perfil (Parte 1)
                if(k.includes('fogo')) pts.FOGO += val;
                if(k.includes('ar')) pts.AR += val;
                if(k.includes('agua')) pts.AGUA += val;
                if(k.includes('terra')) pts.TERRA += val;

                // Estilo (Parte 2)
                if(k.includes('ESTILO') && val > 0) estilo = k.split('::')[1];

                // Categorias
                if(k.includes('::') && val > 0 && !k.includes('ESTILO')) {
                    const [catRaw, opt] = k.split('::');
                    let cat = catRaw.replace('SENSORIAL: ','').replace('PSICOLOGIA DAS ','').replace('CONEXÃO COM A ','');
                    if(cat=='AUDIÇÃO') cat='ACÚSTICA';
                    if(cat=='BIOLÓGICO/TÉRMICO') cat='TÉRMICO';

                    // Separa Visual (Donuts) de Lifestyle (Lista)
                    if(['ILUMINAÇÃO','CORES','FORMAS','ACÚSTICA','TATO','AROMAS','TÉRMICO','GOURMET','BIOFILIA','NATUREZA','MEMÓRIA OLFATIVA','MEMÓRIAS AFETIVAS','CRONOTIPO'].some(x=>cat.includes(x))) {
                        if(!visualGroups[cat]) visualGroups[cat] = [];
                        visualGroups[cat].push({ opt, val });
                    } else {
                        // Separa Lifestyle por Classes
                        if(cat.includes('FASE') || cat.includes('PRIVACIDADE')) lifeGroups.social.push(opt);
                        else if(cat.includes('HOBBIES') || cat.includes('PERSONALIDADE')) lifeGroups.hobbies.push(opt);
                        else lifeGroups.invest.push(opt);
                    }
                }
            });

            // TRAVA DE SEGURANÇA: Limita a 25 pontos
            pts.FOGO = Math.min(pts.FOGO, 25);
            pts.AR = Math.min(pts.AR, 25);
            pts.AGUA = Math.min(pts.AGUA, 25);
            pts.TERRA = Math.min(pts.TERRA, 25);

            // --- 2. PREENCHER HTML ---
            document.getElementById('p-nome').innerText = dados.cliente;
            document.getElementById('p-data').innerText = new Date(dados.data).toLocaleString();
            document.getElementById('p-local').innerText = dados.contato?.cidade || '-';
            document.getElementById('p-email').innerText = dados.contato?.email || '-';
            document.getElementById('p-tel').innerText = dados.contato?.telefone || '-';

            // Perfil & Predominante
            ['fogo','ar','agua','terra'].forEach(id => {
                const upper = id.toUpperCase();
                document.getElementById('card-'+id).classList.remove('predominante');
                document.getElementById('val-'+id).innerText = pts[upper];
                document.getElementById('bar-'+id).style.width = (pts[upper]/25*100)+'%';
            });
            const maxVal = Math.max(pts.FOGO, pts.AR, pts.AGUA, pts.TERRA);
            if(pts.FOGO===maxVal) document.getElementById('card-fogo').classList.add('predominante');
            if(pts.AR===maxVal) document.getElementById('card-ar').classList.add('predominante');
            if(pts.AGUA===maxVal) document.getElementById('card-agua').classList.add('predominante');
            if(pts.TERRA===maxVal) document.getElementById('card-terra').classList.add('predominante');

            // Estilo
            document.getElementById('p-estilo').innerText = estilo.toUpperCase();
            setDescricaoEstilo(estilo);

            // GERAÇÃO DOS DONUTS (Visual Rico)
            const grid = document.getElementById('grid-sensorial');
            grid.innerHTML = '';

            Object.keys(visualGroups).forEach(cat => {
                const items = visualGroups[cat];
                const total = items.reduce((acc, it) => acc + it.val, 0); // Soma total da categoria
                
                let gradientStr = [];
                let currentDeg = 0;
                let legendHTML = '';

                items.forEach((item, i) => {
                    const color = PALETA[i % PALETA.length];
                    const pct = (item.val / total) * 100; // Calcula % real
                    
                    gradientStr.push(`${color} 0 ${currentDeg + pct}%`);
                    currentDeg += pct;

                    legendHTML += `
                    <div class="dc-row">
                        <span class="dc-dot" style="background:${color}"></span>
                        <span class="dc-txt">${item.opt} (${Math.round(pct)}%)</span>
                    </div>`;
                });

                grid.innerHTML += `
                <div class="donut-card">
                    <div class="dc-title">${cat}</div>
                    <div class="donut" style="background: conic-gradient(${gradientStr.join(', ')});">
                        <div class="donut-hole"></div>
                    </div>
                    <div class="dc-legend">${legendHTML}</div>
                </div>`;
            });

            // Lifestyle Separado
            document.getElementById('life-social').innerHTML = lifeGroups.social.map(x=>`<span class="life-item">${x}</span>`).join('');
            document.getElementById('life-hobbies').innerHTML = lifeGroups.hobbies.map(x=>`<span class="life-item">${x}</span>`).join('');
            document.getElementById('life-invest').innerHTML = lifeGroups.invest.map(x=>`<span class="life-item">${x}</span>`).join('');

            // --- 3. EXPORTAR PDF ---
            const el = document.getElementById('folha-a4');
            el.style.display = 'block';
            
            const opt = {
                margin: 0,
                filename: `NeuroBriefing_${dados.cliente}.pdf`, // Nome Completo
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, useCORS: true },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };

            await html2pdf().set(opt).from(el).save();
            el.style.display = 'none';
            btn.innerText = originalText; btn.disabled = false;
        }

        function setDescricaoEstilo(estilo) {
            const map = {
                'Moderno': 'Linhas retas, funcionalidade e clareza visual.',
                'Clássico': 'Simetria, nobreza e valorização da história.',
                'Industrial': 'Metais, concreto aparente e estética urbana.',
                'Rústico': 'Materiais naturais brutos, texturas e calor.',
                'Natural': 'Conexão profunda com a natureza e o orgânico.'
            };
            let desc = "Perfil personalizado.";
            for(let k in map) { if(estilo.includes(k)) desc = map[k]; }
            document.getElementById('p-estilo-desc').innerText = desc;
        }

        init();
    </script>
</body>
</html>