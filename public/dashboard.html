<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Dossi√™ NeuroBriefing</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        /* --- RESET GERAL --- */
        * { box-sizing: border-box; -webkit-print-color-adjust: exact; }
        body { background: #555; margin: 0; padding: 20px; font-family: 'Montserrat', sans-serif; }
        
        /* --- CONTROLE DE TELA (N√£o sai no PDF) --- */
        .painel { max-width: 900px; margin: 0 auto 30px auto; background: white; padding: 20px; border-radius: 8px; }
        .btn-update { background: #2c3e50; color: white; border: none; padding: 10px 20px; cursor: pointer; border-radius: 4px; font-weight: bold; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { padding: 10px; border-bottom: 1px solid #ddd; text-align: left; }

        /* --- ESTRUTURA PDF (A4 R√çGIDO) --- */
        #pdf-container { display: none; }
        
        .page {
            width: 210mm;
            height: 296mm; /* -1mm para evitar bug de p√°gina extra */
            background: white;
            position: relative;
            overflow: hidden; /* Corta qualquer excesso */
            margin: 0 auto;
            padding: 0;
            page-break-after: always; /* For√ßa quebra */
        }
        .page:last-child { page-break-after: avoid; }

        /* --- P√ÅGINA 1: CAPA --- */
        .capa-bg {
            width: 100%; height: 100%;
            background: #fdfdfd;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            border: 20mm solid #fff; /* Margem branca */
            outline: 2px solid #2c3e50; /* Borda decorativa */
            outline-offset: -10mm;
        }
        .logo-main { font-size: 40pt; font-weight: 900; color: #2c3e50; margin-bottom: 10px; letter-spacing: -2px; }
        .tagline { font-size: 10pt; letter-spacing: 5px; text-transform: uppercase; color: #888; margin-bottom: 80px; }
        
        .info-block { text-align: center; margin-bottom: 40px; width: 80%; }
        .lbl { font-size: 8pt; font-weight: 700; color: #aaa; text-transform: uppercase; letter-spacing: 2px; display: block; margin-bottom: 5px; }
        .val { font-size: 18pt; font-weight: 600; color: #333; margin-bottom: 30px; display: block; border-bottom: 1px solid #eee; padding-bottom: 10px; }

        .footer-capa { position: absolute; bottom: 20mm; font-size: 8pt; color: #ccc; text-transform: uppercase; letter-spacing: 1px; }

        /* --- P√ÅGINA 2: M√ìDULO 1 --- */
        .content-pad { padding: 15mm; height: 100%; display: flex; flex-direction: column; }
        
        /* Header Modulo */
        .mod-head { 
            display: flex; justify-content: space-between; align-items: flex-end; 
            border-bottom: 4px solid #2c3e50; padding-bottom: 10px; margin-bottom: 20px;
        }
        .mh-title { font-size: 22pt; font-weight: 800; color: #2c3e50; line-height: 1; }
        .mh-sub { font-size: 9pt; font-weight: 600; color: #7f8c8d; text-transform: uppercase; }

        /* Gr√°fico Compacto */
        .chart-row { display: flex; gap: 15px; margin-bottom: 20px; height: 60px; }
        .c-card { flex: 1; background: #f9f9f9; border: 1px solid #eee; border-radius: 6px; padding: 10px; display: flex; flex-direction: column; justify-content: space-between; }
        .cc-top { display: flex; justify-content: space-between; align-items: center; }
        .cc-lbl { font-size: 9pt; font-weight: 800; text-transform: uppercase; }
        .cc-val { font-size: 14pt; font-weight: 900; }
        .cc-bar { width: 100%; height: 6px; background: #ddd; border-radius: 3px; overflow: hidden; }
        .cc-fill { height: 100%; }

        /* Box Principal (Resultado) */
        .res-box { 
            flex: 1; border: 1px solid #ddd; border-radius: 8px; overflow: hidden; display: flex; flex-direction: column; margin-bottom: 20px; 
        }
        .rb-head { padding: 12px 20px; background: #333; color: white; display: flex; justify-content: space-between; align-items: center; }
        .rb-el { font-size: 16pt; font-weight: 800; text-transform: uppercase; }
        .rb-st { font-size: 9pt; opacity: 0.9; text-transform: uppercase; font-weight: 600; }
        
        .rb-body { display: flex; flex: 1; }
        .rb-col { flex: 1; padding: 15px; }
        .rb-div { border-right: 1px dashed #eee; }

        /* Itens Texto */
        .t-grp { margin-bottom: 12px; }
        .t-lbl { font-size: 7pt; font-weight: 700; color: #999; text-transform: uppercase; margin-bottom: 2px; display: block; }
        .t-val { font-size: 10pt; font-weight: 600; color: #333; line-height: 1.3; }

        .l-tit { font-size: 9pt; font-weight: 800; color: #2c3e50; text-transform: uppercase; border-bottom: 1px solid #eee; padding-bottom: 4px; margin-bottom: 8px; }
        .l-ul { margin: 0; padding: 0; list-style: none; margin-bottom: 15px; }
        .l-li { font-size: 8.5pt; color: #555; margin-bottom: 3px; padding-left: 10px; border-left: 2px solid #eee; }

        /* Ranking Rodap√© */
        .rank-box { background: #f8f9fa; border: 1px solid #eee; border-radius: 6px; padding: 15px; }
        .rk-row { display: flex; justify-content: space-between; font-size: 9pt; border-bottom: 1px dashed #ddd; padding: 4px 0; }
        .rk-row:last-child { border: none; }
        .rk-tit { font-weight: 800; font-size: 9pt; color: #2c3e50; margin-bottom: 5px; text-transform: uppercase; }

        /* Cores */
        .c-fogo { color: #e74c3c; } .bg-fogo { background: #e74c3c; }
        .c-ar { color: #3498db; } .bg-ar { background: #3498db; }
        .c-agua { color: #2980b9; } .bg-agua { background: #2980b9; }
        .c-terra { color: #27ae60; } .bg-terra { background: #27ae60; }

    </style>
</head>
<body>

    <div class="painel">
        <div class="header-painel">
            <h2>Gestor de Dossi√™s</h2>
            <button class="btn-update" onclick="location.reload()">Atualizar</button>
        </div>
        <table>
            <thead><tr><th>Data</th><th>Cliente</th><th>Status</th><th>A√ß√£o</th></tr></thead>
            <tbody id="lista"><tr><td colspan="4">Carregando...</td></tr></tbody>
        </table>
    </div>

    <div id="pdf-container">
        
        <div class="page">
            <div class="capa-bg">
                <div class="logo-main">NEUROBRIEFING</div>
                <div class="tagline">Diagn√≥stico Integral & Estrat√©gia</div>
                
                <div class="info-block" style="margin-top: 50px;">
                    <span class="lbl">Cliente Analisado</span>
                    <span class="val" id="cp-nome">-</span>
                    
                    <span class="lbl">Arquiteto Respons√°vel</span>
                    <span class="val" id="cp-arq">-</span>
                    
                    <span class="lbl">Data do Diagn√≥stico</span>
                    <span class="val" id="cp-data">-</span>
                </div>
                
                <div class="footer-capa">Documento Confidencial ‚Ä¢ Uso Profissional</div>
            </div>
        </div>

        <div class="page">
            <div class="content-pad">
                
                <div class="mod-head">
                    <div>
                        <div class="mh-title">IDENTIDADE DO SER</div>
                        <div class="mh-sub">Mapeamento de Arqu√©tipo & Temperamento</div>
                    </div>
                    <div style="font-size:30pt; font-weight:900; color:#eee;">01</div>
                </div>

                <div class="chart-row">
                    <div class="c-card">
                        <div class="cc-top"><span class="cc-lbl c-fogo">Fogo</span><span class="cc-val c-fogo" id="v-fogo">0</span></div>
                        <div class="cc-bar"><div class="cc-fill bg-fogo" id="b-fogo"></div></div>
                    </div>
                    <div class="c-card">
                        <div class="cc-top"><span class="cc-lbl c-ar">Ar</span><span class="cc-val c-ar" id="v-ar">0</span></div>
                        <div class="cc-bar"><div class="cc-fill bg-ar" id="b-ar"></div></div>
                    </div>
                    <div class="c-card">
                        <div class="cc-top"><span class="cc-lbl c-agua">√Ågua</span><span class="cc-val c-agua" id="v-agua">0</span></div>
                        <div class="cc-bar"><div class="cc-fill bg-agua" id="b-agua"></div></div>
                    </div>
                    <div class="c-card">
                        <div class="cc-top"><span class="cc-lbl c-terra">Terra</span><span class="cc-val c-terra" id="v-terra">0</span></div>
                        <div class="cc-bar"><div class="cc-fill bg-terra" id="b-terra"></div></div>
                    </div>
                </div>

                <div class="res-box">
                    <div class="rb-head" id="rb-header">
                        <div class="rb-el" id="txt-el">ELEMENTO -</div>
                        <div class="rb-st" id="txt-st">-</div>
                    </div>
                    <div class="rb-body">
                        <div class="rb-col rb-div">
                            <div class="t-grp"><span class="t-lbl">‚ö° Energia</span><span class="t-val" id="t-en">-</span></div>
                            <div class="t-grp"><span class="t-lbl">üë§ Para Quem</span><span class="t-val" id="t-quem">-</span></div>
                            <div style="display:flex; gap:10px;">
                                <div class="t-grp" style="flex:1"><span class="t-lbl">üìã Perfil</span><span class="t-val" id="t-perf">-</span></div>
                                <div class="t-grp" style="flex:1"><span class="t-lbl">üß¨ Temp.</span><span class="t-val" id="t-temp">-</span></div>
                            </div>
                            <div class="t-grp"><span class="t-lbl">üé≠ Arqu√©tipos</span><span class="t-val" id="t-arq">-</span></div>
                        </div>
                        <div class="rb-col">
                            <div class="l-tit">üè† Estilos</div>
                            <ul class="l-ul" id="l-est"></ul>
                            
                            <div class="l-tit">‚ú® Caracter√≠sticas</div>
                            <ul class="l-ul" id="l-car"></ul>
                        </div>
                    </div>
                </div>

                <div class="rank-box">
                    <div class="rk-tit">üìä Leitura do Diagn√≥stico</div>
                    <div id="rank-list">
                        </div>
                </div>

                <div style="margin-top:auto; font-size:7pt; color:#ccc; text-align:center; padding-top:10px; border-top:1px solid #eee;">
                    Relat√≥rio gerado por NeuroBriefing Intelligence
                </div>

            </div>
        </div>

    </div>

    <script>
        // --- BASE DE DADOS ---
        const DB = {
            FOGO: { id: 'FOGO', cor: '#e74c3c', titulo: 'Estilos de Ativa√ß√£o', energia: 'A√ß√£o ¬∑ Dire√ß√£o ¬∑ Intensidade', quem: 'Executor-col√©rico', perfil: 'Executor', temp: 'Col√©rico', arq: 'Her√≥i ¬∑ Governante', estilos: ['Contempor√¢neo', 'Industrial', 'Moderno Urbano'], carac: ['Linhas retas', 'Materiais fortes', 'Contraste'] },
            AR: { id: 'AR', cor: '#3498db', titulo: 'Estilos de Express√£o', energia: 'Express√£o ¬∑ Movimento', quem: 'Comunicador-sangu√≠neo', perfil: 'Comunicador', temp: 'Sangu√≠neo', arq: 'Amante ¬∑ Explorador', estilos: ['Escandinavo', 'Boho Chic', 'Ecl√©tico'], carac: ['Luz natural', 'Layout fluido', 'Criatividade'] },
            AGUA: { id: '√ÅGUA', cor: '#2980b9', titulo: 'Estilos de Acolhimento', energia: 'Sensibilidade ¬∑ Ritmo', quem: 'Planejador-fleum√°tico', perfil: 'Planejador', temp: 'Fleum√°tico', arq: 'Cuidador ¬∑ Inocente', estilos: ['Japandi', 'Org√¢nico', 'Wabi-Sabi'], carac: ['Texturas suaves', 'Paleta neutra', 'Conforto'] },
            TERRA: { id: 'TERRA', cor: '#27ae60', titulo: 'Estilos de Estrutura', energia: 'Estrutura ¬∑ Const√¢ncia', quem: 'Analista-melanc√≥lico', perfil: 'Analista', temp: 'Melanc√≥lico', arq: 'S√°bio ¬∑ Criador', estilos: ['Cl√°ssico', 'Neocl√°ssico', 'Moderno Elegante'], carac: ['Simetria', 'Materiais nobres', 'Sobriedade'] }
        };

        let dadosAPI = [];

        async function init() {
            try {
                const req = await fetch('https://api-neurobriefing.onrender.com/api/relatorios');
                dadosAPI = await req.json();
                renderLista();
            } catch(e) { console.error(e); }
        }

        function renderLista() {
            const t = document.getElementById('lista'); t.innerHTML = '';
            [...dadosAPI].reverse().forEach((d, i) => {
                const idx = dadosAPI.length - 1 - i;
                t.innerHTML += `<tr><td>${new Date(d.data).toLocaleDateString()}</td><td><strong>${d.cliente}</strong></td><td>OK</td><td style="text-align:right"><button class="btn-update" onclick="printPDF(${idx}, this)">PDF</button></td></tr>`;
            });
        }

        async function printPDF(index, btn) {
            const d = dadosAPI[index];
            const old = btn.innerText; btn.innerText = "..."; btn.disabled = true;

            // 1. CAPA
            document.getElementById('cp-nome').innerText = d.cliente;
            document.getElementById('cp-arq').innerText = d.contato?.arquiteto || '-';
            document.getElementById('cp-data').innerText = new Date(d.data).toLocaleDateString();

            // 2. C√ÅLCULO
            let p = { FOGO:0, AR:0, AGUA:0, TERRA:0 };
            const r = d.respostas || {};
            Object.keys(r).forEach(k => {
                let v = parseInt(r[k]) || 0;
                if(k.includes('fogo')) p.FOGO += v;
                if(k.includes('ar')) p.AR += v;
                if(k.includes('agua')) p.AGUA += v;
                if(k.includes('terra')) p.TERRA += v;
            });

            // 3. ORDENA√á√ÉO (MAIOR -> MENOR)
            const sorted = [
                { k:'FOGO', ...DB.FOGO, val: p.FOGO },
                { k:'AR', ...DB.AR, val: p.AR },
                { k:'AGUA', ...DB.AGUA, val: p.AGUA },
                { k:'TERRA', ...DB.TERRA, val: p.TERRA }
            ].sort((a,b) => b.val - a.val); // Descendente

            const win = sorted[0];

            // 4. PREENCHER DADOS
            ['FOGO','AR','AGUA','TERRA'].forEach(id => {
                const s = p[id];
                const kid = id.toLowerCase() === '√°gua' ? 'agua' : id.toLowerCase(); // Corre√ß√£o ID
                // No HTML os IDs s√£o v-fogo, v-ar, v-agua, v-terra
                // Aqui ajustamos para pegar o ID correto do objeto DB se necess√°rio, ou usar switch simples
                let domId = id.toLowerCase();
                if(id === '√ÅGUA') domId = 'agua';

                document.getElementById(`v-${domId}`).innerText = s;
                document.getElementById(`b-${domId}`).style.width = Math.min((s/25)*100, 100)+'%';
            });

            // Box Principal
            const head = document.getElementById('rb-header');
            head.style.backgroundColor = win.cor;
            document.getElementById('txt-el').innerText = `ELEMENTO ${win.id}`;
            document.getElementById('txt-st').innerText = win.titulo;
            
            document.getElementById('t-en').innerText = win.energia;
            document.getElementById('t-quem').innerText = win.quem;
            document.getElementById('t-perf').innerText = win.perfil;
            document.getElementById('t-temp').innerText = win.temp;
            document.getElementById('t-arq').innerText = win.arq;

            document.getElementById('l-est').innerHTML = win.estilos.map(i=>`<li>${i}</li>`).join('');
            document.getElementById('l-car').innerHTML = win.carac.map(i=>`<li>${i}</li>`).join('');

            // Ranking Lista (Loop no sorted array)
            const rkContainer = document.getElementById('rank-list');
            rkContainer.innerHTML = '';
            sorted.forEach((item, i) => {
                let label = "Neutro";
                if(i===0) label = "Dominante (Energia Atual)";
                if(i===1) label = "Secund√°rio (Recurso Acess√≠vel)";
                if(i===3) label = "Menos Acessado (A Desenvolver)";
                
                rkContainer.innerHTML += `
                    <div class="rk-row">
                        <span style="font-weight:700; color:#333;">${i+1}¬∫ ${item.id} <span style="font-weight:400; color:#777;">(${item.val} pts)</span></span>
                        <span style="font-size:8pt; color:#555;">${label}</span>
                    </div>
                `;
            });

            // 5. GERAR PDF
            const el = document.getElementById('pdf-container');
            el.style.display = 'block';
            
            const opt = {
                margin: 0,
                filename: `Dossie_${d.cliente}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, useCORS: true },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };
            
            await html2pdf().set(opt).from(el).save();
            el.style.display = 'none';
            btn.innerText = old; btn.disabled = false;
        }

        init();
    </script>
</body>
</html>