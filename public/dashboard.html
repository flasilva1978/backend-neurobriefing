<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard NeuroBriefing</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    
    <style>
        /* ==========================================================================
           ESTILOS CSS (A "Maquiagem" da P√°gina)
           ========================================================================== */
        
        /* Reset b√°sico para garantir que todos os navegadores mostrem igual */
        * { box-sizing: border-box; -webkit-print-color-adjust: exact; } /* Garante que cores de fundo saiam na impress√£o */
        body { font-family: 'Montserrat', sans-serif; background: #f0f2f5; margin: 0; padding: 20px; color: #333; }
        
        /* --- ESTILOS DO PAINEL (TELA DO COMPUTADOR) --- */
        .painel { 
            max-width: 1200px; /* Largura m√°xima para n√£o esticar demais em monitores grandes */
            margin: 0 auto 30px auto; /* Centraliza na tela */
            background: white; 
            padding: 25px; 
            border-radius: 10px; 
            box-shadow: 0 4px 20px rgba(0,0,0,0.05); /* Sombra suave */
        }
        
        .header-painel { 
            display: flex; /* Flexbox: Coloca itens lado a lado */
            justify-content: space-between; /* Espalha: um na esquerda, outro na direita */
            align-items: center; 
            border-bottom: 2px solid #f0f0f0; 
            padding-bottom: 20px; 
            margin-bottom: 20px; 
        }
        
        .hp-title { font-size: 18pt; font-weight: 800; color: #2c3e50; }
        
        /* Bot√£o de Atualizar */
        .btn-refresh { 
            background: #2c3e50; color: white; 
            padding: 10px 20px; border: none; cursor: pointer; 
            border-radius: 6px; font-weight: 700; transition: 0.2s; 
        }
        .btn-refresh:hover { background: #34495e; } /* Efeito ao passar o mouse */
        
        /* Tabela de Clientes */
        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; padding: 15px 10px; background: #f8f9fa; color: #7f8c8d; font-weight: 700; font-size: 8pt; text-transform: uppercase; border-bottom: 2px solid #eee; }
        td { padding: 15px 10px; border-bottom: 1px solid #eee; vertical-align: top; font-size: 9.5pt; }
        tr:hover { background-color: #fafafa; } /* Destaca a linha ao passar o mouse */
        
        /* Elementos da Tabela */
        .cli-name { font-size: 11pt; font-weight: 700; color: #2c3e50; display: block; margin-bottom: 4px; }
        .cli-local { font-size: 8pt; color: #999; display: block; margin-bottom: 8px; }
        
        .contact-row { display: flex; gap: 8px; }
        .btn-contact { text-decoration: none; padding: 4px 8px; border-radius: 4px; font-size: 7.5pt; font-weight: 700; display: inline-flex; align-items: center; gap: 4px; transition: 0.2s; }
        .btn-wa { background: #e8f5e9; color: #2e7d32; border: 1px solid #c8e6c9; } /* Verde WhatsApp */
        .btn-mail { background: #e3f2fd; color: #1565c0; border: 1px solid #bbdefb; } /* Azul Email */
        
        /* Tags de Status (P√≠lulas coloridas) */
        .mod-grid { display: flex; gap: 4px; flex-wrap: wrap; }
        .mod-tag { padding: 3px 6px; border-radius: 4px; font-size: 7pt; font-weight: 700; text-transform: uppercase; background: #eee; color: #bbb; border: 1px solid #e0e0e0; }
        .mod-tag.done { background: #e8f5e9; color: #27ae60; border-color: #c8e6c9; } /* Verde se conclu√≠do */
        
        .btn-pdf { background: #e74c3c; color: white; border: none; padding: 8px 16px; border-radius: 4px; font-weight: 700; font-size: 8pt; cursor: pointer; }
        .btn-pdf:hover { background: #c0392b; }
        .btn-pdf:disabled { background: #ccc; cursor: not-allowed; }
        
        /* --- ESTILOS DO RELAT√ìRIO PDF --- */
        /* Ocultamos da tela normal (display: none) para aparecer s√≥ na gera√ß√£o do PDF */
        #pdf-root { display: none; } 
        
        /* Configura√ß√£o de P√°gina A4 */
        .page { 
            width: 210mm; height: 296mm; /* Tamanho exato A4 */
            background: white; 
            position: relative; overflow: hidden; 
            margin: 0 auto; 
            page-break-after: always; /* For√ßa nova p√°gina ap√≥s cada div .page */
            padding: 0; 
        }
        .page:last-child { page-break-after: avoid; } /* N√£o cria p√°gina em branco no final */
        
        /* Layout da Capa */
        .capa-box { width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center; border: 20mm solid #f4f6f8; text-align: center; }
        .c-logo { font-size: 38pt; font-weight: 900; color: #2c3e50; margin-bottom: 10px; letter-spacing: -1px; }
        .c-sub { font-size: 10pt; letter-spacing: 4px; text-transform: uppercase; color: #7f8c8d; margin-bottom: 80px; }
        .c-info { width: 80%; border-top: 2px solid #2c3e50; border-bottom: 2px solid #2c3e50; padding: 40px 0; margin-bottom: 50px; }
        .ci-lbl { font-size: 8pt; font-weight: 700; color: #aaa; text-transform: uppercase; margin-bottom: 5px; display: block; letter-spacing: 1px; }
        .ci-val { font-size: 16pt; font-weight: 700; color: #2c3e50; margin-bottom: 25px; display: block; }
        .c-foot { position: absolute; bottom: 15mm; font-size: 8pt; color: #ccc; text-transform: uppercase; }
        
        /* Layout Interno das P√°ginas */
        .mod-content { padding: 15mm 15mm 10mm 15mm; height: 100%; display: flex; flex-direction: column; }
        
        /* Cabe√ßalho de cada M√≥dulo */
        .m-head { display: flex; justify-content: space-between; align-items: flex-end; border-bottom: 4px solid #2c3e50; padding-bottom: 10px; margin-bottom: 20px; }
        .mh-tit { font-size: 22pt; font-weight: 800; color: #2c3e50; line-height: 1; }
        .mh-sub { font-size: 9pt; font-weight: 600; color: #7f8c8d; text-transform: uppercase; margin-top: 5px; }
        .mh-meta { text-align: right; }
        .mh-num { font-size: 30pt; font-weight: 900; color: #eee; line-height: 0.8; }
        .mh-time { font-size: 8pt; font-weight: 700; color: #e74c3c; margin-top: 5px; display: block; }
        
        /* Boxes de Conte√∫do (Resultados) */
        .win-box { border: 1px solid #ccc; border-radius: 6px; overflow: hidden; margin-bottom: 20px; }
        .wb-head { padding: 10px 15px; color: white; display: flex; justify-content: space-between; align-items: center; }
        .wb-tit { font-size: 14pt; font-weight: 800; text-transform: uppercase; }
        .wb-sty { font-size: 8pt; font-weight: 600; opacity: 0.95; text-transform: uppercase; }
        .wb-body { padding: 20px; }
        
        /* Box de Conclus√£o T√©cnica */
        .box-conclusao { 
            background: #fdfdfd; 
            border-left: 4px solid #2c3e50; /* Linha lateral grossa */
            padding: 15px; 
            font-size: 9pt; color: #555; line-height: 1.5; 
            margin-top: auto; /* Empurra para o final da p√°gina se usar flexbox */
            margin-bottom: 20px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.03); 
        }
        .bc-tit { font-weight: 800; color: #2c3e50; text-transform: uppercase; margin-bottom: 8px; font-size: 10pt; display: block; }
        
        /* Grids Auxiliares */
        .grid-2 { display: flex; gap: 20px; }
        .col { flex: 1; }
        
        /* Itens de Lista no PDF */
        .item-list { margin-bottom: 8px; border-bottom: 1px dashed #eee; padding-bottom: 8px; }
        .il-lbl { font-size: 8pt; font-weight: 700; color: #2c3e50; text-transform: uppercase; display: block; margin-bottom: 3px; }
        .il-val { font-size: 9pt; color: #555; }
        
        /* Barras de Gr√°fico Sensorial (CSS puro, sem JS complexo) */
        .sensory-bar { display: flex; align-items: center; margin-bottom: 8px; }
        .sb-lbl { width: 100px; font-size: 8pt; font-weight: 700; text-align: right; margin-right: 10px; }
        .sb-track { flex: 1; height: 6px; background: #eee; border-radius: 3px; overflow: hidden; }
        .sb-fill { height: 100%; background: #2c3e50; }
        .sb-val { width: 30px; font-size: 8pt; font-weight: 700; margin-left: 10px; }

        /* Utilit√°rios de Cor */
        .c-fogo { color: #e74c3c; } .bg-fogo { background: #e74c3c; }
        .c-ar { color: #3498db; } .bg-ar { background: #3498db; }
        .c-agua { color: #2980b9; } .bg-agua { background: #2980b9; }
        .c-terra { color: #27ae60; } .bg-terra { background: #27ae60; }
    </style>
</head>
<body>

    <div class="painel">
        <div class="header-painel">
            <div class="hp-title">Dashboard NeuroBriefing</div>
            <button class="btn-refresh" onclick="location.reload()">üîÑ Atualizar Dados</button>
        </div>
        <table>
            <thead>
                <tr>
                    <th style="width: 100px;">Data</th>
                    <th style="width: 30%;">Cliente</th>
                    <th style="width: 20%;">Respons√°vel</th>
                    <th>Status dos M√≥dulos</th>
                    <th style="text-align:right;">A√ß√£o</th>
                </tr>
            </thead>
            <tbody id="lista"><tr><td colspan="5">Carregando dados...</td></tr></tbody>
        </table>
    </div>

    <div id="pdf-root">
        
        <div class="page">
            <div class="capa-box">
                <div class="c-logo">NEUROBRIEFING</div>
                <div class="c-sub">Diagn√≥stico Integral & Estrat√©gia</div>
                <div class="c-info">
                    <span class="ci-lbl">Cliente Analisado</span><span class="ci-val" id="cp-nome">-</span>
                    <span class="ci-lbl">Arquiteto Respons√°vel</span><span class="ci-val" id="cp-arq">-</span>
                    <span class="ci-lbl">Data do Diagn√≥stico</span><span class="ci-val" id="cp-data">-</span>
                </div>
                <div class="c-foot">Documento Confidencial de Uso Profissional</div>
            </div>
        </div>

        <div class="page">
            <div class="mod-content">
                <div class="m-head">
                    <div><div class="mh-tit">IDENTIDADE DO SER</div><div class="mh-sub">Arqu√©tipo & Temperamento</div></div>
                    <div class="mh-meta"><div class="mh-num">01</div><span class="mh-time" id="t1-time">--:--</span></div>
                </div>
                <div class="charts" id="chart-container"></div>
                <div class="win-box">
                    <div class="wb-head" id="wb-head"><div class="wb-tit" id="txt-el">-</div><div class="wb-sty" id="txt-tit">-</div></div>
                    <div class="wb-body" id="m1-content">
                        </div>
                </div>
                <div class="box-conclusao">
                    <span class="bc-tit">DIRETRIZ PROJETUAL (M√ìDULO 1)</span>
                    O perfil identificado exige uma estrat√©gia de design que respeite a "Energia Base" do cliente. 
                    Para perfis quentes (Fogo/Ar), priorize espa√ßos de conex√£o, movimento e express√£o. 
                    Para perfis frios (Terra/√Ågua), foque em acolhimento, privacidade e l√≥gica espacial. 
                    A neuroarquitetura sugere alinhar a complexidade visual ao n√≠vel de est√≠mulo que este c√©rebro suporta.
                </div>
                <div class="ft-note">NeuroBriefing Intelligence</div>
            </div>
        </div>

        <div class="page">
            <div class="mod-content">
                <div class="m-head">
                    <div><div class="mh-tit">IDENTIDADE VISUAL</div><div class="mh-sub">Estilo & Prefer√™ncia Est√©tica</div></div>
                    <div class="mh-meta"><div class="mh-num">02</div><span class="mh-time" id="t2-time">--:--</span></div>
                </div>
                
                <div class="win-box" style="flex:0 auto; margin-bottom:30px;">
                    <div class="wb-head" style="background:#2c3e50;">
                        <div class="wb-tit">ESTILO PREDOMINANTE</div>
                        <div class="wb-sty" style="color:#f1c40f;">MATCH PRINCIPAL</div>
                    </div>
                    <div class="wb-body" style="padding:25px; text-align:center;">
                        <h2 style="margin:0; font-size:26pt; color:#2c3e50; text-transform:uppercase;" id="vis-top1-nome">-</h2>
                        <p style="font-size:10pt; color:#777; margin-top:10px; font-style:italic;" id="vis-top1-desc">Baseado na maior afinidade demonstrada.</p>
                        <div style="margin-top:15px; font-size:14pt; font-weight:bold; color:#27ae60;">AFINIDADE: <span id="vis-top1-nota">-</span>%</div>
                    </div>
                </div>

                <div id="m2-content">
                    </div>

                <div class="box-conclusao">
                    <span class="bc-tit">DIRETRIZ PROJETUAL (M√ìDULO 2)</span>
                    A prefer√™ncia est√©tica n√£o √© apenas "gosto", √© a linguagem visual que o c√©rebro do cliente decodifica com facilidade.
                    Utilize o estilo predominante como base estrutural (revestimentos, marcenaria) e os estilos secund√°rios para camadas de decora√ß√£o (objetos, t√™xteis).
                    Isso cria um ambiente "leg√≠vel" para o c√©rebro, reduzindo a carga cognitiva e aumentando a sensa√ß√£o de pertencimento (Place Attachment).
                </div>
                <div class="ft-note">NeuroBriefing Intelligence</div>
            </div>
        </div>

        <div class="page">
            <div class="mod-content">
                <div class="m-head">
                    <div><div class="mh-tit">IDENTIDADE SENSORIAL</div><div class="mh-sub">Percep√ß√£o Multissensorial & Biofilia</div></div>
                    <div class="mh-meta"><div class="mh-num">03</div><span class="mh-time" id="t3-time">--:--</span></div>
                </div>
                
                <div class="grid-2">
                    <div class="col" id="m3-visual">
                        </div>
                    <div class="col" id="m3-outros">
                        </div>
                </div>

                <div class="box-conclusao">
                    <span class="bc-tit">CONCLUS√ÉO & APLICA√á√ÉO PR√ÅTICA (NEUROARQUITETURA SENSORIAL)</span>
                    Baseado em <strong>Juhani Pallasmaa</strong> ("Os Olhos da Pele") e <strong>Charles Spence</strong> (Gastrof√≠sica), o ambiente deve ser projetado para al√©m da vis√£o.
                    <br><br>
                    <strong>1. Regula√ß√£o Sensorial:</strong> Se o cliente indicou alta sensibilidade auditiva/olfativa, crie "zonas de descompress√£o" com materiais fonoabsorventes (madeira, tecidos) e ventila√ß√£o controlada.
                    <br>
                    <strong>2. Biofilia Aplicada:</strong> Utilize a prefer√™ncia de vegeta√ß√£o indicada n√£o apenas como decora√ß√£o, mas como redutor de cortisol (estresse).
                    <br>
                    <strong>3. Tato e Textura:</strong> A "m√£o quer ver o que os olhos tocam". Use texturas t√°teis (pedra rugosa, veludo, linho) nas √°reas de perman√™ncia para ativar a mem√≥ria t√°til e aumentar a sensa√ß√£o de acolhimento.
                </div>
                <div class="ft-note">NeuroBriefing Intelligence</div>
            </div>
        </div>

        <div class="page">
            <div class="mod-content">
                <div class="m-head">
                    <div><div class="mh-tit">IDENTIDADE MEM√ìRIAS</div><div class="mh-sub">Mem√≥rias Expl√≠citas & Impl√≠citas</div></div>
                    <div class="mh-meta"><div class="mh-num">04</div><span class="mh-time" id="t4-time">--:--</span></div>
                </div>

                <div class="win-box">
                    <div class="wb-head" style="background:#8e44ad;">
                        <div class="wb-tit">MEM√ìRIA EXPL√çCITA (CONSCIENTE)</div>
                        <div class="wb-sty">O QUE O CLIENTE DIZ</div>
                    </div>
                    <div class="wb-body" id="m4-expl" style="display:flex; flex-wrap:wrap; gap:15px;">
                        </div>
                </div>

                <div class="win-box">
                    <div class="wb-head" style="background:#2c3e50;">
                        <div class="wb-tit">MEM√ìRIA IMPL√çCITA (INCONSCIENTE)</div>
                        <div class="wb-sty">O QUE O CLIENTE SENTE/FAZ</div>
                    </div>
                    <div class="wb-body" id="m4-impl">
                        </div>
                </div>

                <div class="box-conclusao">
                    <span class="bc-tit">CONCLUS√ÉO & APLICA√á√ÉO PR√ÅTICA (NEUROARQUITETURA E MEM√ìRIA)</span>
                    Baseado em <strong>Endel Tulving</strong> e <strong>Daniel Kahneman</strong> (Sistemas 1 e 2), a casa deve ser um espelho da biografia do cliente.
                    <br><br>
                    <strong>1. Mem√≥ria Epis√≥dica (O Filme):</strong> Crie "altares de mem√≥ria" para os objetos/hist√≥rias citados nas respostas expl√≠citas. Isso ancora a identidade.
                    <br>
                    <strong>2. Mem√≥ria Procedural (O H√°bito):</strong> Respeite o fluxo de movimento e a "bagun√ßa funcional" identificada. N√£o force uma organiza√ß√£o que contrarie o "piloto autom√°tico" do cliente (Sistema 1).
                    <br>
                    <strong>3. Priming (Gatilhos):</strong> Use as cores e materiais citados (ex: madeira, azul) como gatilhos sutis para evocar calma ou energia sem que o cliente precise racionalizar.
                </div>
                <div class="ft-note">NeuroBriefing Intelligence</div>
            </div>
        </div>

    </div>

    <script>
        // 1. BASE DE CONHECIMENTO (Interpreta√ß√£o dos Dados)
        // Aqui definimos o que cada resposta "significa" para gerar os textos do relat√≥rio.
        const DB = {
            FOGO: { id:'FOGO', cor:'#e74c3c', class:'fogo', titulo:'Estilos de Ativa√ß√£o', energia:'A√ß√£o ¬∑ Intensidade', quem:'Executor-col√©rico', perfil:'Executor', estilos:['Contempor√¢neo', 'Industrial'], carac:['Linhas retas', 'Contraste'] },
            AR: { id:'AR', cor:'#3498db', class:'ar', titulo:'Estilos de Express√£o', energia:'Express√£o ¬∑ Conex√£o', quem:'Comunicador-sangu√≠neo', perfil:'Comunicador', estilos:['Boho Chic', 'Ecl√©tico'], carac:['Luz natural', 'Criatividade'] },
            AGUA: { id:'√ÅGUA', cor:'#2980b9', class:'agua', titulo:'Estilos de Acolhimento', energia:'Sensibilidade ¬∑ Ritmo', quem:'Planejador-fleum√°tico', perfil:'Planejador', estilos:['Japandi', 'Org√¢nico'], carac:['Texturas suaves', 'Conforto'] },
            TERRA: { id:'TERRA', cor:'#27ae60', class:'terra', titulo:'Estilos de Estrutura', energia:'Estrutura ¬∑ Const√¢ncia', quem:'Analista-melanc√≥lico', perfil:'Analista', estilos:['Cl√°ssico', 'Moderno Elegante'], carac:['Simetria', 'Sobriedade'] }
        };

        // Dicion√°rio para traduzir c√≥digos (est_contemp) em nomes bonitos (Contempor√¢neo)
        const DB_VISUAL = {
            'est_contemp': 'Contempor√¢neo', 'est_ind': 'Industrial', 'est_urb': 'Moderno Urbano', 'est_tech': 'High Tech', 'est_luxo': 'Luxo Moderno',
            'est_scandi': 'Escandinavo', 'est_cont_leve': 'Contempor√¢neo Leve', 'est_boho': 'Boho Chic', 'est_japandi': 'Japandi', 'est_wabi': 'Wabi-Sabi',
            'est_organico': 'Org√¢nico', 'est_coastal': 'Coastal', 'est_natural': 'Natural Chic',
            'est_mid': 'Mid-Century', 'est_ecletico': 'Ecl√©tico', 'est_classico': 'Cl√°ssico', 'est_neoclass': 'Neocl√°ssico'
        };

        let dadosAPI = [];

        // 2. FUN√á√ÉO DE INICIALIZA√á√ÉO
        // Carrega os dados da API assim que a p√°gina abre.
        async function init() {
            try {
                // Requisi√ß√£o GET para o servidor
                const req = await fetch('https://api-neurobriefing.onrender.com/api/relatorios');
                dadosAPI = await req.json();
                
                // Ordena por data (mais recente primeiro)
                dadosAPI.sort((a, b) => new Date(b.data) - new Date(a.data));
                
                // Desenha a tabela
                renderTable();
            } catch(e) { console.error("Erro ao carregar dados:", e); }
        }

        // 3. FUN√á√ÉO AUXILIAR: Verifica se um m√≥dulo foi feito
        // Procura se existe alguma resposta que come√ßa com o prefixo (ex: 'mem_')
        function checkMod(r, keyStart) {
            if(!r) return false;
            return Object.keys(r).some(k => k.startsWith(keyStart));
        }

        // 4. FUN√á√ÉO AUXILIAR: Formata Segundos -> MM:SS
        function formatTime(s) {
            s = parseInt(s);
            if (isNaN(s)) return "00:00"; 
            const min = Math.floor(s / 60);
            const sec = s % 60;
            return `${min < 10 ? '0'+min : min}:${sec < 10 ? '0'+sec : sec}`;
        }

        // 5. RENDERIZA A TABELA DE CLIENTES
        function renderTable() {
            const t = document.getElementById('lista'); t.innerHTML = '';
            if(dadosAPI.length === 0) { t.innerHTML = '<tr><td colspan="5">Nenhum dossi√™ encontrado.</td></tr>'; return; }

            dadosAPI.forEach((d, i) => {
                const r = d.respostas || {};
                const c = d.contato || {};
                
                // L√≥gica de Detec√ß√£o dos M√≥dulos (Atualizada com M√≥dulo 4)
                const hasHumana = checkMod(r, 'fogo') || checkMod(r, 'ar_');
                const hasVisual = checkMod(r, 'est_');
                // M√≥dulo 3 inclui visual, auditivo, olfativo, tatil e gustativo
                const hasSensorial = checkMod(r, 'vis_') || checkMod(r, 'aud_') || checkMod(r, 'bio_');
                // M√≥dulo 4 s√£o as mem√≥rias
                const hasMemorias = checkMod(r, 'mem_');

                t.innerHTML += `
                    <tr>
                        <td style="font-size:9pt; color:#666;">${new Date(d.data).toLocaleDateString()}</td>
                        <td><span class="cli-name">${d.cliente}</span><span class="cli-local">${c.cidade||'-'}</span></td>
                        <td>${c.arquiteto || '-'}</td>
                        <td>
                            <div class="mod-grid">
                                <span class="mod-tag ${hasHumana?'done':''}">Humana</span>
                                <span class="mod-tag ${hasVisual?'done':''}">Visual</span>
                                <span class="mod-tag ${hasSensorial?'done':''}">Sensorial</span>
                                <span class="mod-tag ${hasMemorias?'done':''}">Mem√≥rias</span>
                            </div>
                        </td>
                        <td style="text-align:right"><button class="btn-pdf" onclick="makePDF(${i}, this)">Gerar PDF</button></td>
                    </tr>
                `;
            });
        }

        // 6. FUN√á√ÉO GERADORA DE PDF (A M√°gica!)
        async function makePDF(index, btn) {
            const d = dadosAPI[index];
            const original = btn.innerText; btn.innerText = "Gerando..."; btn.disabled = true;
            const r = d.respostas || {};

            // --- PREENCHIMENTO DA CAPA ---
            document.getElementById('cp-nome').innerText = d.cliente;
            document.getElementById('cp-arq').innerText = d.contato?.arquiteto || '-';
            document.getElementById('cp-data').innerText = new Date(d.data).toLocaleDateString();

            // --- M√ìDULO 1: C√ÅLCULO DE TEMPERAMENTO ---
            let p = { FOGO:0, AR:0, AGUA:0, TERRA:0 };
            Object.keys(r).forEach(k => {
                let v = parseInt(r[k]) || 0;
                if(k.startsWith('fogo')) p.FOGO += v;
                if(k.startsWith('ar_')) p.AR += v;
                if(k.startsWith('agua')) p.AGUA += v;
                if(k.startsWith('terra')) p.TERRA += v;
            });
            // Ordena do maior para o menor
            const sorted = [{k:'FOGO',...DB.FOGO,v:p.FOGO},{k:'AR',...DB.AR,v:p.AR},{k:'AGUA',...DB.AGUA,v:p.AGUA},{k:'TERRA',...DB.TERRA,v:p.TERRA}].sort((a,b)=>b.v-a.v);
            const win = sorted[0]; // Vencedor
            
            // Preenche HTML do Mod 1
            document.getElementById('t1-time').innerText = formatTime(d.tempos?.[0] || 0);
            let chartHTML = '';
            sorted.forEach(i => {
                chartHTML += `<div class="cc-box"><div class="cc-top"><span class="cc-lbl c-${i.class}">${i.id}</span><span class="cc-val">${i.v}</span></div><div class="cc-bar"><div class="cc-fill bg-${i.class}" style="width:${Math.min((i.v/25)*100,100)}%"></div></div></div>`;
            });
            document.getElementById('chart-container').innerHTML = chartHTML;
            document.getElementById('wb-head').style.backgroundColor = win.cor;
            document.getElementById('txt-el').innerText = win.id;
            document.getElementById('txt-tit').innerText = win.titulo;
            document.getElementById('m1-content').innerHTML = `
                <div class="info-row"><span class="il">Energia</span><span class="iv">${win.energia}</span></div>
                <div class="info-row"><span class="il">Perfil</span><span class="iv">${win.perfil}</span></div>
                <div class="info-row"><span class="il">Estilos Sugeridos</span><span class="iv">${win.estilos.join(', ')}</span></div>
            `;

            // --- M√ìDULO 2: ESTILOS VISUAIS ---
            document.getElementById('t2-time').innerText = formatTime(d.tempos?.[1] || 0);
            let visualScores = [];
            Object.keys(r).forEach(k => {
                if(k.startsWith('est_')) visualScores.push({nome: DB_VISUAL[k]||k, val: parseInt(r[k])||0});
            });
            visualScores.sort((a,b) => b.val - a.val);
            
            if(visualScores.length > 0) {
                document.getElementById('vis-top1-nome').innerText = visualScores[0].nome;
                document.getElementById('vis-top1-nota').innerText = visualScores[0].val;
                // Lista os 4 pr√≥ximos estilos
                document.getElementById('m2-content').innerHTML = visualScores.slice(1,5).map(i => `<div class="item-list"><span class="il-lbl">${i.nome}</span><span class="il-val">${i.val}% de afinidade</span></div>`).join('');
            }

            // --- M√ìDULO 3: SENSORIAL ---
            document.getElementById('t3-time').innerText = formatTime(d.tempos?.[2] || 0);
            let m3v = '', m3o = '';
            
            // Coluna 1: Visual & Biofilia
            Object.keys(r).forEach(k => {
                if((k.startsWith('vis_') || k.startsWith('bio_')) && typeof r[k] === 'number') {
                    let label = k.replace('vis_', '').replace('bio_', '').replace(/_/g, ' ').toUpperCase();
                    m3v += `<div class="sensory-bar"><span class="sb-lbl">${label}</span><div class="sb-track"><div class="sb-fill" style="width:${r[k]}%"></div></div><span class="sb-val">${r[k]}</span></div>`;
                }
            });
            // Coluna 2: Outros Sentidos (Audio, Olfato, Tato)
            Object.keys(r).forEach(k => {
                if((k.startsWith('aud_') || k.startsWith('olf_') || k.startsWith('tat_')) && typeof r[k] === 'number') {
                    let label = k.replace('aud_', '').replace('olf_', '').replace('tat_', '').replace(/_/g, ' ').toUpperCase();
                    m3o += `<div class="sensory-bar"><span class="sb-lbl">${label}</span><div class="sb-track"><div class="sb-fill" style="width:${r[k]}%"></div></div><span class="sb-val">${r[k]}</span></div>`;
                }
            });
            document.getElementById('m3-visual').innerHTML = `<span class="il-lbl" style="margin-bottom:15px; border-bottom:1px solid #ddd;">VISUAL & BIOFILIA</span>` + m3v;
            document.getElementById('m3-outros').innerHTML = `<span class="il-lbl" style="margin-bottom:15px; border-bottom:1px solid #ddd;">OUTROS SENTIDOS</span>` + m3o;

            // --- M√ìDULO 4: MEM√ìRIAS ---
            document.getElementById('t4-time').innerText = formatTime(d.tempos?.[3] || 0);
            let explHTML = '', implHTML = '';
            
            // Filtra Mem√≥rias
            Object.keys(r).forEach(k => {
                // Mem√≥rias Expl√≠citas (Epis√≥dica e Sem√¢ntica)
                if(k.startsWith('mem_epi') || k.startsWith('mem_sem')) {
                    if(typeof r[k] === 'string') {
                        // Se for texto livre
                        explHTML += `<div style="width:100%; margin-bottom:12px; background:#f9f9f9; padding:8px; border-radius:4px;"><span class="il-lbl" style="color:#8e44ad">${k.replace('mem_epi_','Hist√≥ria: ').replace('mem_sem_','Conceito: ').toUpperCase().replace(/_/g,' ')}</span><span class="il-val" style="font-style:italic">"${r[k]}"</span></div>`;
                    } else {
                        // Se for escala (barra)
                        explHTML += `<div style="width:48%; margin-bottom:8px;"><span class="il-lbl">${k.split('_')[2].toUpperCase()}</span><div class="sb-track"><div class="sb-fill" style="width:${r[k]}%; background:#8e44ad"></div></div><div style="font-size:7pt; text-align:right; color:#8e44ad; font-weight:bold;">${r[k]}%</div></div>`;
                    }
                }
                // Mem√≥rias Impl√≠citas (Procedural, Priming, Condicionamento)
                if(k.startsWith('mem_proc') || k.startsWith('mem_prim') || k.startsWith('mem_cond')) {
                    if(typeof r[k] === 'string') {
                        implHTML += `<div style="width:100%; margin-bottom:12px; background:#f9f9f9; padding:8px; border-radius:4px;"><span class="il-lbl" style="color:#2c3e50">${k.replace('mem_proc_','Rotina: ').replace('mem_cond_','Gatilho: ').toUpperCase().replace(/_/g,' ')}</span><span class="il-val" style="font-style:italic">"${r[k]}"</span></div>`;
                    } else {
                        implHTML += `<div style="width:48%; margin-bottom:8px;"><span class="il-lbl">${k.split('_')[2].toUpperCase()}</span><div class="sb-track"><div class="sb-fill" style="width:${r[k]}%; background:#2c3e50"></div></div><div style="font-size:7pt; text-align:right; color:#2c3e50; font-weight:bold;">${r[k]}%</div></div>`;
                    }
                }
            });
            document.getElementById('m4-expl').innerHTML = explHTML || 'Sem dados.';
            document.getElementById('m4-impl').innerHTML = implHTML || 'Sem dados.';

            // --- FINALIZA√á√ÉO E DOWNLOAD ---
            const el = document.getElementById('pdf-root');
            el.style.display = 'block'; // Mostra o HTML do PDF
            window.scrollTo(0, 0); // Sobe a tela para garantir renderiza√ß√£o

            setTimeout(async () => {
                const opt = {
                    margin: 0, // Margem zero pois controlamos via CSS
                    filename: `Dossie_${d.cliente}_Completo.pdf`,
                    image: { type: 'jpeg', quality: 0.98 },
                    html2canvas: { scale: 2, scrollY: 0, useCORS: true }, // Scale 2 melhora qualidade
                    jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
                };
                // Gera o PDF
                await html2pdf().set(opt).from(el).save();
                
                // Restaura o estado do bot√£o
                el.style.display = 'none';
                btn.innerText = original; btn.disabled = false;
            }, 1000); // Espera 1s para garantir que imagens carregaram
        }

        // Inicia o app
        init();
    </script>
</body>
</html>