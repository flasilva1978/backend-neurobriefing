<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dossi√™ NeuroBriefing | Identidade do Ser</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    
    <style>
        /* --- ESTRUTURA GERAL --- */
        body { font-family: 'Montserrat', sans-serif; background: #eef2f5; margin: 0; padding: 20px; color: #333; }
        .painel { max-width: 1000px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .header-painel { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding-bottom: 15px; margin-bottom: 15px; }
        .btn { background: #2c3e50; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: 700; font-size: 10pt; }
        table { width: 100%; border-collapse: collapse; font-size: 10pt; }
        th { text-align: left; padding: 10px; background: #34495e; color: white; }
        td { padding: 10px; border-bottom: 1px solid #eee; }

        /* --- PDF A4 (DIAGRAMA√á√ÉO R√çGIDA) --- */
        #relatorio-pdf { width: 210mm; background: white; margin: 20px auto; display: none; }
        
        .pagina { 
            width: 210mm; 
            height: 296mm; /* Altura exata A4 */
            padding: 12mm 15mm; /* Margens equilibradas */
            box-sizing: border-box; 
            position: relative; 
            background: white; 
            overflow: hidden; /* Garante que nada vaze */
        }

        /* HEADER DO RELAT√ìRIO */
        .header-pdf { text-align: center; margin-bottom: 20px; border-bottom: 2px solid #2c3e50; padding-bottom: 10px; }
        .brand { font-size: 24pt; font-weight: 900; color: #2c3e50; letter-spacing: -1px; line-height: 1; }
        .sub-brand { font-size: 7.5pt; letter-spacing: 4px; text-transform: uppercase; color: #7f8c8d; display: block; margin-top: 3px; }
        
        .meta-info { 
            display: flex; justify-content: center; gap: 20px; margin-top: 10px; 
            font-size: 8pt; color: #555; background: #f4f6f8; 
            padding: 6px 15px; border-radius: 20px; display: inline-flex;
        }

        /* SE√á√ÉO T√çTULO */
        .sec-title { 
            background: #2c3e50; color: white; padding: 6px 12px; border-radius: 4px; 
            display: flex; justify-content: space-between; align-items: center; 
            margin-bottom: 15px; 
        }
        .sec-txt { font-size: 11pt; font-weight: 700; text-transform: uppercase; }
        .sec-sub { font-size: 7pt; opacity: 0.8; text-transform: uppercase; letter-spacing: 1px; }

        /* GR√ÅFICO DE BARRAS (PERFIL) */
        .grid-perfil { display: flex; gap: 8px; margin-bottom: 20px; }
        .card-perfil { flex: 1; border: 1px solid #e0e0e0; border-radius: 5px; padding: 8px; text-align: center; background: #fff; }
        .cp-label { font-size: 8pt; font-weight: 800; text-transform: uppercase; margin-bottom: 2px; display: block; }
        .cp-val { font-size: 16pt; font-weight: 900; display: block; line-height: 1; }
        .bar-container { width: 100%; height: 5px; background: #eee; border-radius: 3px; margin-top: 5px; overflow: hidden; }
        .bar-fill { height: 100%; border-radius: 3px; }

        /* --- QUADRO PRINCIPAL (DOMINANTE) --- */
        .box-dominante { 
            border: 1px solid #ddd; border-radius: 8px; overflow: hidden; 
            margin-bottom: 15px; background: #fff;
            box-shadow: 0 4px 10px rgba(0,0,0,0.03);
        }
        .dom-header { 
            padding: 10px 15px; color: white; display: flex; align-items: center; justify-content: space-between;
        }
        .dom-title { font-size: 14pt; font-weight: 900; text-transform: uppercase; }
        .dom-subtitle { font-size: 9pt; font-weight: 600; opacity: 0.9; text-transform: uppercase; letter-spacing: 1px; }

        /* LAYOUT 2 COLUNAS (DIAGRAMA√á√ÉO) */
        .dom-body { display: flex; }
        .dom-col { padding: 15px; }
        .dom-left { width: 45%; border-right: 1px dashed #eee; background: #fcfcfc; }
        .dom-right { width: 55%; background: #fff; }

        /* ITENS DE TEXTO */
        .info-group { margin-bottom: 10px; }
        .info-label { font-size: 7pt; font-weight: 700; color: #95a5a6; text-transform: uppercase; display: block; margin-bottom: 2px; }
        .info-val { font-size: 9.5pt; font-weight: 600; color: #333; line-height: 1.3; }
        
        .list-title { font-size: 9pt; font-weight: 800; color: #2c3e50; text-transform: uppercase; margin-bottom: 5px; display: flex; align-items: center; gap: 5px; }
        .custom-list { padding: 0; margin: 0 0 12px 0; list-style: none; }
        .custom-list li { 
            font-size: 8.5pt; color: #555; margin-bottom: 3px; padding-left: 12px; position: relative; line-height: 1.3;
        }
        .custom-list li::before { 
            content: "‚Ä¢"; color: #ccc; font-weight: bold; position: absolute; left: 0; 
        }

        /* RODAP√â (RANKING + CONCEITO) */
        .footer-grid { display: flex; gap: 10px; margin-top: auto; }
        
        .ranking-box { 
            flex: 1.2; border: 1px solid #eee; border-radius: 6px; padding: 10px; background: #fafafa; 
        }
        .concept-box { 
            flex: 0.8; background: #fdfefe; border: 1px solid #eee; border-radius: 6px; padding: 10px; border-left: 3px solid #f1c40f; 
        }

        .rank-row { display: flex; justify-content: space-between; font-size: 8pt; margin-bottom: 4px; border-bottom: 1px dashed #e0e0e0; padding-bottom: 2px; }
        .rank-row:last-child { border: none; }
        .rank-lbl { font-weight: 700; color: #2c3e50; }
        .rank-desc { color: #7f8c8d; font-style: italic; }

        .footer-legal { 
            position: absolute; bottom: 8mm; left: 0; right: 0; text-align: center; 
            font-size: 6pt; color: #bdc3c7; letter-spacing: 1px; 
        }

        /* CORES */
        .c-fogo { color: #e74c3c; } .bg-fogo { background: #e74c3c; }
        .c-ar { color: #3498db; } .bg-ar { background: #3498db; }
        .c-agua { color: #2980b9; } .bg-agua { background: #2980b9; }
        .c-terra { color: #27ae60; } .bg-terra { background: #27ae60; }
    </style>
</head>
<body>

    <div class="painel">
        <div class="header-painel">
            <div>
                <h2 style="margin:0;">Dashboard Administrativo</h2>
                <small style="color:#777;">Gerenciador de Dossi√™s</small>
            </div>
            <button class="btn" onclick="location.reload()">üîÑ Atualizar Lista</button>
        </div>
        <table>
            <thead><tr><th>Data</th><th>Cliente</th><th>Status</th><th style="text-align:right">A√ß√£o</th></tr></thead>
            <tbody id="lista"><tr><td colspan="4">Buscando dados...</td></tr></tbody>
        </table>
    </div>

    <div id="relatorio-pdf">
        <div class="pagina">
            
            <div class="header-pdf">
                <div class="brand">NEUROBRIEFING</div>
                <span class="sub-brand">Diagn√≥stico Integral & Estrat√©gia Projetual</span>
                <div class="meta-info">
                    <span>CLIENTE: <strong id="r-nome">Carregando...</strong></span>
                    <span>DATA: <span id="r-data">--/--/--</span></span>
                </div>
            </div>

            <div class="sec-title">
                <span class="sec-txt">1. Identidade do Ser</span>
                <span class="sec-sub">Mapeamento de Arqu√©tipo & Temperamento</span>
            </div>

            <div class="grid-perfil">
                <div class="card-perfil"><span class="cp-label c-fogo">Fogo</span><span class="cp-val c-fogo" id="v-fogo">0</span><div class="bar-container"><div class="bar-fill bg-fogo" id="b-fogo"></div></div></div>
                <div class="card-perfil"><span class="cp-label c-ar">Ar</span><span class="cp-val c-ar" id="v-ar">0</span><div class="bar-container"><div class="bar-fill bg-ar" id="b-ar"></div></div></div>
                <div class="card-perfil"><span class="cp-label c-agua">√Ågua</span><span class="cp-val c-agua" id="v-agua">0</span><div class="bar-container"><div class="bar-fill bg-agua" id="b-agua"></div></div></div>
                <div class="card-perfil"><span class="cp-label c-terra">Terra</span><span class="cp-val c-terra" id="v-terra">0</span><div class="bar-container"><div class="bar-fill bg-terra" id="b-terra"></div></div></div>
            </div>

            <div class="box-dominante" id="box-main">
                <div class="dom-header" id="dom-header">
                    <div class="dom-title" id="txt-elemento">ELEMENTO</div>
                    <div class="dom-subtitle" id="txt-estilo-titulo">ESTILO</div>
                </div>
                
                <div class="dom-body">
                    <div class="dom-col dom-left">
                        <div class="info-group">
                            <span class="info-label">‚ö° Energia</span>
                            <div class="info-val" id="txt-energia">-</div>
                        </div>
                        <div class="info-group">
                            <span class="info-label">üë§ Para Quem</span>
                            <div class="info-val" id="txt-quem">-</div>
                        </div>
                        <div style="display:flex; gap:10px;">
                            <div class="info-group" style="flex:1;">
                                <span class="info-label">üìã Perfil</span>
                                <div class="info-val" id="txt-perfil">-</div>
                            </div>
                            <div class="info-group" style="flex:1;">
                                <span class="info-label">üß¨ Temperamento</span>
                                <div class="info-val" id="txt-temp">-</div>
                            </div>
                        </div>
                        <div class="info-group">
                            <span class="info-label">üé≠ Arqu√©tipos Associados</span>
                            <div class="info-val" id="txt-arq">-</div>
                        </div>
                    </div>

                    <div class="dom-col dom-right">
                        <div class="list-title">üè† Estilos Inclu√≠dos</div>
                        <ul class="custom-list" id="lista-estilos"></ul>

                        <div class="list-title">‚ú® Caracter√≠sticas do Ambiente</div>
                        <ul class="custom-list" id="lista-carac"></ul>
                    </div>
                </div>
            </div>

            <div class="footer-grid">
                <div class="ranking-box">
                    <div class="list-title" style="font-size:8pt; border-bottom:1px solid #ddd; padding-bottom:4px; margin-bottom:8px;">üìä Leitura do Diagn√≥stico</div>
                    <div class="rank-row">
                        <span class="rank-lbl">1Ô∏è‚É£ Dominante <span id="r-dom-id"></span></span>
                        <span class="rank-desc">Energia predominante atual</span>
                    </div>
                    <div class="rank-row">
                        <span class="rank-lbl">2Ô∏è‚É£ Secund√°rio <span id="r-sec-id"></span></span>
                        <span class="rank-desc">Recurso acess√≠vel</span>
                    </div>
                    <div class="rank-row">
                        <span class="rank-lbl">3Ô∏è‚É£ Menos Acessado <span id="r-last-id"></span></span>
                        <span class="rank-desc">√Årea de desenvolvimento</span>
                    </div>
                </div>

                <div class="concept-box">
                    <div class="list-title" style="color:#f39c12; font-size:8pt;">üí° Princ√≠pio Fundamental</div>
                    <div style="font-size:7.5pt; color:#555; font-style:italic; line-height:1.4;">
                        "Voc√™ n√£o √© um tipo fixo. Voc√™ √© um sistema vivo em equil√≠brio din√¢mico. Este guia serve para criar estrat√©gias que harmonizem sua natureza."
                    </div>
                </div>
            </div>

            <div class="footer-legal">
                Relat√≥rio gerado pela plataforma NeuroBriefing Intelligence ‚Ä¢ Uso exclusivo profissional
            </div>
        </div>
    </div>

    <script>
        // --- BASE DE DADOS RICA ---
        const DB = {
            FOGO: {
                cor: '#e74c3c', // Vermelho
                titulo_estilo: 'ESTILOS DE ATIVA√á√ÉO',
                energia: 'A√ß√£o ¬∑ Dire√ß√£o ¬∑ Intensidade',
                quem: 'Pessoas executor-col√©ricas, arqu√©tipos de a√ß√£o',
                perfil: 'Executor',
                temp: 'Col√©rico',
                arq: 'Her√≥i ¬∑ Governante ¬∑ Fora-da-Lei',
                estilos: ['Contempor√¢neo', 'Industrial', 'Moderno Urbano', 'High Tech', 'Luxo Moderno'],
                carac: ['Contrastes marcantes', 'Linhas retas e definidas', 'Materiais fortes (metal, concreto)', 'Ilumina√ß√£o direcionada', 'Paleta com profundidade']
            },
            AR: {
                cor: '#3498db', // Azul Claro
                titulo_estilo: 'ESTILOS DE EXPRESS√ÉO',
                energia: 'Express√£o ¬∑ Conex√£o ¬∑ Movimento',
                quem: 'Comunicador-sangu√≠neo, arqu√©tipos relacionais',
                perfil: 'Comunicador',
                temp: 'Sangu√≠neo',
                arq: 'Amante ¬∑ Bobo da Corte ¬∑ Explorador',
                estilos: ['Escandinavo', 'Contempor√¢neo Leve', 'Mid-Century Modern', 'Boho Chic', 'Ecl√©tico Curado'],
                carac: ['Luz natural abundante', 'Layout fluido e aberto', 'Mistura criativa de elementos', 'Cores claras com pontos vibrantes', 'Sensa√ß√£o de liberdade']
            },
            AGUA: {
                cor: '#2980b9', // Azul Escuro
                titulo_estilo: 'ESTILOS DE ACOLHIMENTO',
                energia: 'Sensibilidade ¬∑ Adapta√ß√£o ¬∑ Ritmo',
                quem: 'Planejador-fleum√°tico, arqu√©tipos do cuidado',
                perfil: 'Planejador',
                temp: 'Fleum√°tico',
                arq: 'Cuidador ¬∑ Inocente ¬∑ Mago',
                estilos: ['Japandi', 'Org√¢nico Contempor√¢neo', 'Wabi-Sabi', 'Coastal Sofisticado', 'Natural Chic'],
                carac: ['Texturas suaves e t√°teis', 'Paleta neutra quente', 'Materiais naturais (linho, madeira)', 'Ilumina√ß√£o difusa', 'Ambientes que desaceleram']
            },
            TERRA: {
                cor: '#27ae60', // Verde
                titulo_estilo: 'ESTILOS DE ESTRUTURA',
                energia: 'Estrutura ¬∑ Profundidade ¬∑ Const√¢ncia',
                quem: 'Analista-melanc√≥lico, arqu√©tipos de sabedoria',
                perfil: 'Analista',
                temp: 'Melanc√≥lico',
                arq: 'S√°bio ¬∑ Criador ¬∑ √ìrf√£o',
                estilos: ['Cl√°ssico Atemporal', 'Neocl√°ssico', 'Tradicional Contempor√¢neo', 'Moderno Elegante', 'Colonial Atualizado'],
                carac: ['Propor√ß√£o e simetria', 'Materiais nobres e dur√°veis', 'Paleta s√≥bria e profunda', 'Organiza√ß√£o visual clara', 'Sensa√ß√£o de perman√™ncia']
            }
        };

        let dadosAPI = [];

        async function init() {
            try {
                // Atualize com sua URL real se mudar
                const req = await fetch('https://api-neurobriefing.onrender.com/api/relatorios');
                dadosAPI = await req.json();
                renderTable();
            } catch(e) { console.error("Erro API:", e); }
        }

        function renderTable() {
            const tbody = document.getElementById('lista');
            tbody.innerHTML = '';
            if(dadosAPI.length === 0) { tbody.innerHTML = '<tr><td colspan="4">Nenhum teste encontrado.</td></tr>'; return; }
            
            [...dadosAPI].reverse().forEach((d, i) => {
                const idx = dadosAPI.length - 1 - i;
                tbody.innerHTML += `
                    <tr>
                        <td>${new Date(d.data).toLocaleDateString()}</td>
                        <td><strong>${d.cliente}</strong></td>
                        <td><span style="background:#e8f5e9; color:#2e7d32; padding:2px 6px; border-radius:4px; font-size:8pt;">Conclu√≠do</span></td>
                        <td style="text-align:right"><button class="btn" onclick="gerarPDF(${idx}, this)">üìÑ PDF</button></td>
                    </tr>
                `;
            });
        }

        async function gerarPDF(index, btn) {
            const dados = dadosAPI[index];
            const originalTxt = btn.innerText; 
            btn.innerText = "‚è≥"; btn.disabled = true;

            // 1. Processar Pontua√ß√£o
            let pts = { FOGO:0, AR:0, AGUA:0, TERRA:0 };
            const resp = dados.respostas || {};
            
            Object.keys(resp).forEach(k => {
                let val = parseInt(resp[k], 10) || 0;
                if(k.includes('fogo')) pts.FOGO += val;
                if(k.includes('ar')) pts.AR += val;
                if(k.includes('agua')) pts.AGUA += val;
                if(k.includes('terra')) pts.TERRA += val;
            });

            // Ordenar para achar o Vencedor
            const sorted = [
                { id: 'FOGO', val: pts.FOGO, ...DB.FOGO },
                { id: 'AR', val: pts.AR, ...DB.AR },
                { id: 'AGUA', val: pts.AGUA, ...DB.AGUA },
                { id: 'TERRA', val: pts.TERRA, ...DB.TERRA }
            ].sort((a,b) => b.val - a.val);

            const dom = sorted[0]; // Dominante
            const sec = sorted[1];
            const last = sorted[3];

            // 2. Preencher HTML
            document.getElementById('r-nome').innerText = dados.cliente;
            document.getElementById('r-data').innerText = new Date(dados.data).toLocaleDateString();

            // Barras
            ['FOGO','AR','AGUA','TERRA'].forEach(key => {
                const k = key.toLowerCase();
                const score = pts[key];
                document.getElementById(`v-${k}`).innerText = score;
                document.getElementById(`b-${k}`).style.width = Math.min((score/25)*100, 100) + '%';
            });

            // Box Dominante (Estilo Visual)
            document.getElementById('dom-header').style.backgroundColor = dom.cor;
            document.getElementById('txt-elemento').innerText = `ELEMENTO ${dom.id}`;
            document.getElementById('txt-estilo-titulo').innerText = dom.titulo_estilo;

            // Coluna Esquerda (Psico)
            document.getElementById('txt-energia').innerText = dom.energia;
            document.getElementById('txt-quem').innerText = dom.quem;
            document.getElementById('txt-perfil').innerText = dom.perfil;
            document.getElementById('txt-temp').innerText = dom.temp;
            document.getElementById('txt-arq').innerText = dom.arq;

            // Coluna Direita (Arqui)
            document.getElementById('lista-estilos').innerHTML = dom.estilos.map(x => `<li>${x}</li>`).join('');
            document.getElementById('lista-carac').innerHTML = dom.carac.map(x => `<li>${x}</li>`).join('');

            // Rodap√© (Ranking)
            document.getElementById('r-dom-id').innerHTML = `<strong>${dom.id}</strong> (${dom.val} pts)`;
            document.getElementById('r-sec-id').innerHTML = `<strong>${sec.id}</strong> (${sec.val} pts)`;
            document.getElementById('r-last-id').innerHTML = `<strong>${last.id}</strong> (${last.val} pts)`;

            // 3. Exportar
            const element = document.getElementById('relatorio-pdf');
            element.style.display = 'block';

            setTimeout(async () => {
                const opt = {
                    margin: 0,
                    filename: `NeuroBriefing_${dados.cliente}.pdf`,
                    image: { type: 'jpeg', quality: 0.99 },
                    html2canvas: { scale: 2, useCORS: true },
                    jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
                };
                await html2pdf().set(opt).from(element).save();
                
                element.style.display = 'none';
                btn.innerText = originalTxt; btn.disabled = false;
            }, 800);
        }

        init();
    </script>
</body>
</html>