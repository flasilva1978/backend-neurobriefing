<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel NeuroBriefing</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        /* --- TELA DO SISTEMA --- */
        body { font-family: 'Segoe UI', sans-serif; background: #eef2f5; margin: 0; color: #333; }
        .painel { max-width: 1100px; margin: 30px auto; background: white; padding: 30px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        h2 { margin-top: 0; border-bottom: 2px solid #333; padding-bottom: 10px; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 13px; }
        th { text-align: left; background: #f8f9fa; padding: 12px; border-bottom: 2px solid #ddd; }
        td { padding: 12px; border-bottom: 1px solid #eee; }
        .btn { background: #e74c3c; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 12px; }
        .btn:hover { background: #c0392b; }

        /* --- PDF ONE PAGE (HIGH RES) --- */
        #folha-a4 {
            width: 210mm; height: 296mm; /* A4 Exato */
            background: white; margin: 50px auto; padding: 10mm 12mm;
            box-sizing: border-box; display: none; position: relative;
            font-family: 'Montserrat', sans-serif; color: #2c3e50;
            overflow: hidden; /* Garante que não corte */
        }

        /* HEADER */
        .header { display: flex; justify-content: space-between; border-bottom: 3px solid #2c3e50; padding-bottom: 8px; margin-bottom: 15px; }
        .logo h1 { margin: 0; font-size: 20pt; font-weight: 900; letter-spacing: -1px; line-height: 1; }
        .logo span { font-size: 7pt; letter-spacing: 3px; text-transform: uppercase; color: #7f8c8d; }
        .meta { text-align: right; font-size: 7pt; line-height: 1.3; color: #555; }
        .meta strong { color: #000; font-size: 8pt; }

        /* TITULOS DE SEÇÃO */
        .sec-title { 
            font-size: 8pt; font-weight: 800; text-transform: uppercase; color: #2c3e50; 
            border-bottom: 1px solid #ddd; margin: 10px 0 8px 0; padding-bottom: 2px;
        }

        /* 1. PERFIL (4 BARRAS VERTICAIS) */
        .row-perfil { display: flex; gap: 8px; margin-bottom: 12px; justify-content: space-between; }
        .card-perfil { flex: 1; background: #fdfdfd; border: 1px solid #eee; border-radius: 4px; padding: 6px; text-align: center; }
        .cp-head { font-size: 6.5pt; font-weight: 700; text-transform: uppercase; margin-bottom: 4px; display: block; }
        .cp-val { font-size: 11pt; font-weight: 800; margin-top: 4px; display: block; }
        
        .bar-v-track { width: 8px; height: 35px; background: #eee; margin: 0 auto; border-radius: 4px; position: relative; display: flex; align-items: flex-end; }
        .bar-v-fill { width: 100%; border-radius: 4px; }

        /* 2. ESTILO (HERO COMPACTO) */
        .hero-estilo { 
            background: #2c3e50; color: white; padding: 10px 15px; border-radius: 4px; 
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; 
        }
        .he-label { font-size: 6pt; text-transform: uppercase; opacity: 0.7; letter-spacing: 1px; }
        .he-title { font-size: 18pt; font-weight: 900; text-transform: uppercase; margin: 0; line-height: 1; }
        .he-desc { width: 60%; font-size: 7pt; font-style: italic; opacity: 0.9; text-align: right; line-height: 1.2; }

        /* 3. MAPA SENSORIAL (O QUE VOCÊ QUERIA: DONUTS COLORIDOS) */
        .grid-sensorial { 
            display: grid; grid-template-columns: repeat(4, 1fr); /* 4 colunas */
            gap: 10px; row-gap: 15px; margin-bottom: 15px;
        }
        
        .sensory-card { text-align: center; }
        .sc-title { font-size: 6pt; font-weight: 700; color: #7f8c8d; text-transform: uppercase; margin-bottom: 4px; white-space: nowrap; }
        
        /* O Gráfico de Rosca Bonito */
        .donut { 
            width: 40px; height: 40px; margin: 0 auto; border-radius: 50%; 
            position: relative; display: flex; justify-content: center; align-items: center;
            background: #eee; /* Fallback */
        }
        .donut-hole { width: 28px; height: 28px; background: white; border-radius: 50%; position: absolute; z-index: 1; }
        
        /* Legenda de Porcentagem abaixo do gráfico */
        .sc-legend { margin-top: 4px; text-align: center; }
        .sc-tag { display: block; font-size: 5.5pt; color: #333; line-height: 1.1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .sc-dot { display: inline-block; width: 4px; height: 4px; border-radius: 50%; margin-right: 2px; }

        /* 4. LIFESTYLE (LISTA) */
        .grid-life { display: flex; flex-wrap: wrap; gap: 5px; }
        .tag-life { 
            border: 1px solid #ddd; border-radius: 3px; padding: 3px 6px; 
            font-size: 6pt; background: #fff; color: #555;
        }
        .tag-life b { color: #2c3e50; text-transform: uppercase; margin-right: 3px; }

        /* CORES */
        .c-fogo { color: #e74c3c; } .bg-fogo { background: #e74c3c; }
        .c-ar { color: #3498db; } .bg-ar { background: #3498db; }
        .c-agua { color: #2980b9; } .bg-agua { background: #2980b9; }
        .c-terra { color: #27ae60; } .bg-terra { background: #27ae60; }

        /* FOOTER */
        .footer { 
            position: absolute; bottom: 10mm; left: 12mm; right: 12mm; 
            border-top: 1px solid #eee; padding-top: 5px; 
            text-align: center; font-size: 6pt; color: #aaa; 
        }
    </style>
</head>
<body>

    <div class="painel">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h2>Dashboard Administrativo</h2>
            <button class="btn" onclick="location.reload()">Atualizar Lista</button>
        </div>
        <table>
            <thead><tr><th>Data</th><th>Cliente</th><th>Ação</th></tr></thead>
            <tbody id="lista"><tr><td colspan="3">Carregando...</td></tr></tbody>
        </table>
    </div>

    <div id="folha-a4">
        <div class="header">
            <div class="logo">
                <h1>NEUROBRIEFING</h1>
                <span>Diagnóstico Integral</span>
            </div>
            <div class="meta">
                CLIENTE: <strong id="p-nome">-</strong><br>
                DATA: <span id="p-data">-</span> | LOCAL: <span id="p-local">-</span><br>
                EMAIL: <span id="p-email">-</span>
            </div>
        </div>

        <div class="sec-title">1. Perfil Comportamental (Natureza)</div>
        <div class="row-perfil">
            <div class="card-perfil">
                <span class="cp-head c-fogo">FOGO</span>
                <div class="bar-v-track"><div id="bar-fogo" class="bar-v-fill bg-fogo"></div></div>
                <span id="val-fogo" class="cp-val c-fogo">0</span>
            </div>
            <div class="card-perfil">
                <span class="cp-head c-ar">AR</span>
                <div class="bar-v-track"><div id="bar-ar" class="bar-v-fill bg-ar"></div></div>
                <span id="val-ar" class="cp-val c-ar">0</span>
            </div>
            <div class="card-perfil">
                <span class="cp-head c-agua">ÁGUA</span>
                <div class="bar-v-track"><div id="bar-agua" class="bar-v-fill bg-agua"></div></div>
                <span id="val-agua" class="cp-val c-agua">0</span>
            </div>
            <div class="card-perfil">
                <span class="cp-head c-terra">TERRA</span>
                <div class="bar-v-track"><div id="bar-terra" class="bar-v-fill bg-terra"></div></div>
                <span id="val-terra" class="cp-val c-terra">0</span>
            </div>
        </div>

        <div class="sec-title">2. Identidade Visual Predominante</div>
        <div class="hero-estilo">
            <div>
                <div class="he-label">Tendência Identificada</div>
                <div class="he-title" id="p-estilo">EM ANÁLISE</div>
            </div>
            <div class="he-desc" id="p-estilo-desc">Análise em andamento.</div>
        </div>

        <div class="sec-title">3. Mapa Sensorial & Preferências</div>
        <div class="grid-sensorial" id="grid-roscas">
            </div>

        <div class="sec-title">4. Lifestyle & Estratégia</div>
        <div class="grid-life" id="grid-life"></div>

        <div class="footer">Relatório gerado via NeuroBriefing Intelligence. Documento Confidencial.</div>
    </div>

    <script>
        let dadosAPI = [];
        
        // Cores fixas para os gráficos de rosca (Para ficar colorido igual ao anexo)
        const PALETA = ['#3498db', '#e74c3c', '#f1c40f', '#2ecc71', '#9b59b6'];

        async function init() {
            try {
                const res = await fetch('/api/relatorios');
                dadosAPI = await res.json();
                const tbody = document.getElementById('lista');
                tbody.innerHTML = '';
                [...dadosAPI].reverse().forEach((d, i) => {
                    const idx = dadosAPI.length - 1 - i;
                    tbody.innerHTML += `
                        <tr>
                            <td>${new Date(d.data).toLocaleDateString()}</td>
                            <td><strong>${d.cliente}</strong></td>
                            <td><button class="btn" onclick="gerarPDF(${idx}, this)">Gerar PDF</button></td>
                        </tr>`;
                });
            } catch(e) { console.error(e); }
        }

        async function gerarPDF(index, btn) {
            const dados = dadosAPI[index];
            if(!dados) return;
            const txt = btn.innerText; btn.innerText = "⏳ ..."; btn.disabled = true;

            // --- A. PREPARAR DADOS ---
            let pts = { FOGO:0, AR:0, AGUA:0, TERRA:0 };
            let estilo = "Em Análise";
            
            // Agrupador para as roscas (Ex: ILUMINAÇÃO -> { Quente: 100, Fria: 0 })
            let gruposVisuais = {}; 
            let listaLifestyle = [];

            const resp = dados.respostas || {};

            Object.keys(resp).forEach(k => {
                // 1. CORREÇÃO MATEMÁTICA REAL (Evita "515")
                let val = Number(resp[k]); 
                if(isNaN(val)) val = 0; 

                // Perfil
                if(k.includes('fogo')) pts.FOGO += val;
                if(k.includes('ar')) pts.AR += val;
                if(k.includes('agua')) pts.AGUA += val;
                if(k.includes('terra')) pts.TERRA += val;

                // Estilo
                if(k.includes('ESTILO') && val > 0) estilo = k.split('::')[1];

                // Sensoriais
                if(k.includes('::') && !k.includes('ESTILO')) {
                    const [catRaw, opt] = k.split('::');
                    // Limpa nomes
                    let cat = catRaw.replace('SENSORIAL: ', '').replace('PSICOLOGIA DAS ', '').replace('CONEXÃO COM A ', '');
                    if(cat=='AUDIÇÃO') cat='ACÚSTICA';
                    if(cat=='BIOLÓGICO/TÉRMICO') cat='CONF. TÉRMICO';

                    // Separa o que é visual (Rosca) do que é Lifestyle (Lista)
                    if(['ILUMINAÇÃO','CORES','FORMAS','TEXTURAS','ACÚSTICA','AROMAS','CONF. TÉRMICO','GOURMET','BIOFILIA','CRONOTIPO','MEMÓRIAS'].some(x=>cat.includes(x))) {
                        // Lógica para Rosca: Acumula valores
                        if(!gruposVisuais[cat]) gruposVisuais[cat] = [];
                        gruposVisuais[cat].push({ nome: opt, valor: val });
                    } else {
                        // Lifestyle vira lista
                        if(val > 0) listaLifestyle.push({ cat, opt });
                    }
                }
            });

            // --- B. PREENCHER HTML ---
            document.getElementById('p-nome').innerText = dados.cliente;
            document.getElementById('p-data').innerText = new Date(dados.data).toLocaleString();
            document.getElementById('p-local').innerText = dados.contato?.cidade || '-';
            document.getElementById('p-email').innerText = dados.contato?.email || '-';

            // Perfil (Barras)
            const max = 25; 
            const setBar = (id, v) => {
                document.getElementById('val-'+id).innerText = v;
                document.getElementById('bar-'+id).style.height = (v/max*100)+'%';
            };
            setBar('fogo', pts.FOGO); setBar('ar', pts.AR); setBar('agua', pts.AGUA); setBar('terra', pts.TERRA);

            // Estilo
            document.getElementById('p-estilo').innerText = estilo.toUpperCase();
            setDescricaoEstilo(estilo);

            // --- C. GERAR AS ROSCAS COLORIDAS (DONUTS) ---
            const grid = document.getElementById('grid-roscas');
            grid.innerHTML = '';

            Object.keys(gruposVisuais).forEach(categoria => {
                const opcoes = gruposVisuais[categoria];
                const total = opcoes.reduce((acc, it) => acc + it.valor, 0);
                
                // Monta o gradiente CSS (A mágica do visual)
                let gradiente = [];
                let currentPct = 0;
                let legendas = '';

                opcoes.forEach((op, i) => {
                    if(op.valor > 0) {
                        const pct = (op.valor / total) * 100;
                        const color = PALETA[i % PALETA.length];
                        
                        // Adiciona fatia ao gradiente
                        gradiente.push(`${color} 0 ${currentPct + pct}%`);
                        currentPct += pct;

                        // Cria legenda colorida
                        legendas += `<span class="sc-tag"><span class="sc-dot" style="background:${color}"></span>${op.nome} (${Math.round(pct)}%)</span>`;
                    }
                });

                // HTML do Card
                grid.innerHTML += `
                    <div class="sensory-card">
                        <div class="sc-title">${categoria}</div>
                        <div class="donut" style="background: conic-gradient(${gradiente.join(', ')});">
                            <div class="donut-hole"></div>
                        </div>
                        <div class="sc-legend">${legendas}</div>
                    </div>
                `;
            });

            // Lifestyle
            const lifeContainer = document.getElementById('grid-life');
            lifeContainer.innerHTML = '';
            listaLifestyle.forEach(l => {
                lifeContainer.innerHTML += `<div class="tag-life"><b>${l.cat}:</b> ${l.opt}</div>`;
            });

            // --- D. SALVAR PDF ---
            const element = document.getElementById('folha-a4');
            element.style.display = 'block';
            
            const opt = {
                margin: 0,
                filename: `NeuroBriefing_${dados.cliente.split(' ')[0]}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, useCORS: true },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };

            await html2pdf().set(opt).from(element).save();
            element.style.display = 'none';
            btn.innerText = txt; btn.disabled = false;
        }

        function setDescricaoEstilo(estilo) {
            const descricoes = {
                'Moderno': 'Funcionalidade, linhas retas e clareza visual.',
                'Clássico': 'Simetria, nobreza e valorização da história.',
                'Industrial': 'Metais, concreto aparente e estética urbana.',
                'Rústico': 'Materiais naturais brutos, texturas e acolhimento.',
                'Natural': 'Conexão profunda com a natureza e materiais orgânicos.'
            };
            let desc = "Perfil personalizado.";
            for(let k in descricoes) { if(estilo.includes(k)) desc = descricoes[k]; }
            document.getElementById('p-estilo-desc').innerText = desc;
        }

        init();
    </script>
</body>
</html>