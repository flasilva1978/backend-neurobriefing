<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel NeuroBriefing</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    
    <style>
        /* --- TELA PC --- */
        body { font-family: 'Segoe UI', sans-serif; background: #e0e5ec; margin: 0; padding: 20px; }
        .painel { max-width: 1200px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .btn { background: #e74c3c; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; font-weight: bold; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 13px; }
        th { text-align: left; background: #2c3e50; color: white; padding: 10px; }
        td { padding: 10px; border-bottom: 1px solid #eee; }

        /* --- PDF ONE PAGE (A4 RÍGIDO) --- */
        #folha-a4 {
            width: 210mm; 
            height: 297mm; 
            background: white; 
            margin: 20px auto; 
            padding: 12mm 10mm; /* Margens equilibradas */
            box-sizing: border-box; 
            display: none; 
            position: relative;
            font-family: 'Montserrat', sans-serif; 
            color: #2c3e50;
            overflow: hidden; 
        }

        /* HEADER */
        .header { display: flex; justify-content: space-between; border-bottom: 2px solid #2c3e50; padding-bottom: 5px; margin-bottom: 8px; }
        .logo h1 { margin: 0; font-size: 20pt; font-weight: 900; letter-spacing: -1px; line-height: 1; }
        .logo span { font-size: 7pt; letter-spacing: 3px; text-transform: uppercase; color: #7f8c8d; }
        .meta { text-align: right; font-size: 6.5pt; line-height: 1.3; color: #555; }

        /* TÍTULOS */
        .sec-title { 
            background: #2c3e50; color: white; padding: 2px 8px; 
            font-size: 7.5pt; font-weight: 700; text-transform: uppercase; 
            margin-bottom: 6px; display: flex; justify-content: space-between;
        }

        /* 1. PERFIL */
        .row-perfil { display: flex; gap: 8px; margin-bottom: 8px; }
        .card-perfil { flex: 1; border: 1px solid #eee; border-radius: 4px; padding: 4px; text-align: center; position: relative; background: #fff; }
        .predominante { border: 2px solid #f1c40f; background: #fffcf5; }
        .badge { position: absolute; top: -5px; left: 50%; transform: translateX(-50%); background: #f1c40f; color: #000; font-size: 4.5pt; font-weight: 800; padding: 1px 5px; border-radius: 3px; text-transform: uppercase; display: none; }
        .predominante .badge { display: block; }
        .cp-val { font-size: 13pt; font-weight: 900; margin-bottom: 2px; line-height: 1; }
        .bar-container { width: 100%; height: 4px; background: #eee; border-radius: 2px; overflow: hidden; }
        .bar-fill { height: 100%; }

        /* 2. ESTILO (Lateral) */
        .style-row { 
            display: flex; align-items: center; justify-content: space-between; 
            background: #f8f9fa; border-left: 5px solid #2c3e50; 
            padding: 6px 12px; margin-bottom: 10px; height: 65px;
        }
        .st-info { width: 50%; }
        .st-name { font-size: 16pt; font-weight: 900; text-transform: uppercase; line-height: 1; color: #2c3e50; }
        
        .st-visual { width: 45%; display: flex; align-items: center; gap: 5px; justify-content: flex-end; }
        .st-chart { width: 55px; height: 55px; }
        .st-legend { font-size: 5pt; width: 80px; }

        /* 3 & 4. GRIDS (LAYOUT LADO A LADO) */
        .grid-charts { 
            display: grid; grid-template-columns: repeat(3, 1fr); /* 3 colunas mais largas para caber legenda lateral */
            gap: 6px; row-gap: 6px; margin-bottom: 8px;
        }
        /* Lifestyle: 3 colunas também */
        .grid-charts.life { margin-bottom: 0; }

        /* CARD DO GRÁFICO */
        .chart-card { 
            border: 1px solid #f0f0f0; border-radius: 4px; padding: 3px; 
            display: flex; align-items: center; /* Lado a Lado */
            height: 48px; /* Altura fixa controlada */
            background: #fff;
        }
        
        /* Esquerda: Donut */
        .card-left { width: 35%; display: flex; justify-content: center; align-items: center; }
        .canvas-box { width: 38px; height: 38px; position: relative; }

        /* Direita: Info + Legenda */
        .card-right { width: 65%; padding-left: 5px; display: flex; flex-direction: column; justify-content: center; }
        .cc-title { font-size: 5pt; font-weight: 800; color: #7f8c8d; text-transform: uppercase; margin-bottom: 2px; white-space: nowrap; overflow: hidden; }
        
        /* LEGENDA HTML LATERAL */
        .cc-legend { display: flex; flex-direction: column; }
        .leg-row { display: flex; align-items: center; line-height: 1; margin-bottom: 1px; }
        .leg-box { width: 4px; height: 4px; margin-right: 2px; flex-shrink: 0; border-radius: 50%; }
        .leg-txt { font-size: 4.5pt; color: #333; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 80px; }

        /* CORES */
        .c-fogo { color: #e74c3c; } .bg-fogo { background: #e74c3c; }
        .c-ar { color: #3498db; } .bg-ar { background: #3498db; }
        .c-agua { color: #2980b9; } .bg-agua { background: #2980b9; }
        .c-terra { color: #27ae60; } .bg-terra { background: #27ae60; }

        .footer { 
            position: absolute; bottom: 5mm; left: 10mm; right: 10mm; 
            border-top: 1px solid #ccc; padding-top: 2px; 
            text-align: center; font-size: 5.5pt; color: #999; 
        }
    </style>
</head>
<body>

    <div class="painel">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <h2 style="margin:0;">Dashboard Administrativo</h2>
            <button class="btn" style="background:#333;" onclick="location.reload()">Atualizar Lista</button>
        </div>
        <table>
            <thead><tr><th>Data</th><th>Cliente</th><th>Email</th><th>Celular</th><th>Tempo</th><th>Relatório</th></tr></thead>
            <tbody id="lista"><tr><td colspan="6">Carregando...</td></tr></tbody>
        </table>
    </div>

    <div id="folha-a4">
        <div class="header">
            <div class="logo"><h1>NEUROBRIEFING</h1><span>Diagnóstico Integral</span></div>
            <div class="meta">
                CLIENTE: <strong id="p-nome">-</strong><br>
                DATA: <span id="p-data">-</span> | LOCAL: <span id="p-local">-</span><br>
                EMAIL: <span id="p-email">-</span> | TEL: <span id="p-tel">-</span><br>
                TEMPO: <strong id="p-tempo">-</strong>
            </div>
        </div>

        <div class="sec-title">1. Perfil Comportamental (Arquétipo) <span style="font-size:6pt; font-weight:400;">Escala 0-25 pts</span></div>
        <div class="row-perfil">
            <div class="card-perfil" id="cp-fogo"><span class="badge">Predominante</span><span style="font-size:6.5pt; font-weight:800; color:#e74c3c;">FOGO</span><span class="cp-val c-fogo" id="v-fogo">0</span><div class="bar-container"><div class="bar-fill bg-fogo" id="b-fogo"></div></div></div>
            <div class="card-perfil" id="cp-ar"><span class="badge">Predominante</span><span style="font-size:6.5pt; font-weight:800; color:#3498db;">AR</span><span class="cp-val c-ar" id="v-ar">0</span><div class="bar-container"><div class="bar-fill bg-ar" id="b-ar"></div></div></div>
            <div class="card-perfil" id="cp-agua"><span class="badge">Predominante</span><span style="font-size:6.5pt; font-weight:800; color:#2980b9;">ÁGUA</span><span class="cp-val c-agua" id="v-agua">0</span><div class="bar-container"><div class="bar-fill bg-agua" id="b-agua"></div></div></div>
            <div class="card-perfil" id="cp-terra"><span class="badge">Predominante</span><span style="font-size:6.5pt; font-weight:800; color:#27ae60;">TERRA</span><span class="cp-val c-terra" id="v-terra">0</span><div class="bar-container"><div class="bar-fill bg-terra" id="b-terra"></div></div></div>
        </div>

        <div class="sec-title">2. Identidade Visual</div>
        <div class="style-row">
            <div class="st-info">
                <div style="font-size:5.5pt; font-weight:700; color:#999; text-transform:uppercase;">Tendência Identificada</div>
                <div class="st-name" id="p-estilo">EM ANÁLISE</div>
                <div style="font-size:6.5pt; font-style:italic; color:#555;" id="p-estilo-desc">...</div>
            </div>
            <div class="st-visual">
                <div class="st-chart"><canvas id="chart-estilo"></canvas></div>
                <div class="st-legend" id="legend-estilo"></div>
            </div>
        </div>

        <div class="sec-title">3. Mapa Sensorial & Preferências</div>
        <div class="grid-charts" id="grid-sensorial"></div>

        <div class="sec-title">4. Lifestyle & Estratégia</div>
        <div class="grid-charts life" id="grid-lifestyle"></div>

        <div class="footer">
            Relatório gerado automaticamente pela plataforma NeuroBriefing Intelligence. Documento Confidencial de Uso Profissional.
        </div>
    </div>

    <script>
        let dadosAPI = [];
        const PALETA = ['#e74c3c', '#3498db', '#f1c40f', '#2ecc71', '#9b59b6', '#34495e'];

        async function init() {
            try {
                const req = await fetch('/api/relatorios');
                dadosAPI = await req.json();
                renderTable();
            } catch(e){}
        }

        function renderTable() {
            const tbody = document.getElementById('lista');
            tbody.innerHTML = '';
            [...dadosAPI].reverse().forEach((d, i) => {
                const idx = dadosAPI.length - 1 - i;
                const tempo = d.duracao ? `${Math.floor(d.duracao/60)}m ${d.duracao%60}s` : '-';
                tbody.innerHTML += `
                    <tr>
                        <td>${new Date(d.data).toLocaleDateString()}</td>
                        <td><strong>${d.cliente}</strong></td>
                        <td>${d.contato?.email || '-'}</td>
                        <td>${d.contato?.telefone || '-'}</td>
                        <td>${tempo}</td>
                        <td style="text-align:right"><button class="btn" onclick="gerarPDF(${idx}, this)">PDF</button></td>
                    </tr>`;
            });
        }

        async function gerarPDF(index, btn) {
            const dados = dadosAPI[index];
            if(!dados) return;
            const originalTxt = btn.innerText; btn.innerText = "⏳"; btn.disabled = true;

            // 1. DADOS
            let pts = { FOGO:0, AR:0, AGUA:0, TERRA:0 };
            let estiloData = {}; let visualGroups = {}; let lifeGroups = {};

            const resp = dados.respostas || {};
            Object.keys(resp).forEach(k => {
                let val = parseInt(resp[k], 10); if(isNaN(val)) val = 0;

                if(k.includes('fogo')) pts.FOGO += val;
                if(k.includes('ar')) pts.AR += val;
                if(k.includes('agua')) pts.AGUA += val;
                if(k.includes('terra')) pts.TERRA += val;

                if(k.includes('ESTILO') && val > 0) estiloData[k.split('::')[1]] = (estiloData[k.split('::')[1]]||0) + val;

                if(k.includes('::') && val > 0 && !k.includes('ESTILO')) {
                    const [catRaw, opt] = k.split('::');
                    let cat = catRaw.replace('SENSORIAL: ','').replace('PSICOLOGIA DAS ','').replace('CONEXÃO COM A ','');
                    if(cat=='AUDIÇÃO') cat='ACÚSTICA'; if(cat=='BIOLÓGICO/TÉRMICO') cat='TÉRMICO';

                    const lifeKeys = ['FASE DE VIDA','HOBBIES','PRIVACIDADE','INVESTIMENTO','PERSONALIDADE'];
                    let isLife = lifeKeys.some(x => cat.includes(x));
                    let target = isLife ? lifeGroups : visualGroups;
                    if(!target[cat]) target[cat] = [];
                    target[cat].push({ opt, val });
                }
            });

            // Trava
            ['FOGO','AR','AGUA','TERRA'].forEach(k => pts[k] = Math.min(pts[k], 25));
            
            document.getElementById('p-nome').innerText = dados.cliente;
            document.getElementById('p-data').innerText = new Date(dados.data).toLocaleString();
            document.getElementById('p-local').innerText = dados.contato?.cidade || '-';
            document.getElementById('p-email').innerText = dados.contato?.email || '-';
            document.getElementById('p-tel').innerText = dados.contato?.telefone || '-';
            document.getElementById('p-tempo').innerText = `${Math.floor((dados.duracao||0)/60)}m ${((dados.duracao||0)%60)}s`;

            // Barras
            ['fogo','ar','agua','terra'].forEach(id => {
                const k = id.toUpperCase();
                document.getElementById('cp-'+id).classList.remove('predominante');
                document.getElementById('v-'+id).innerText = pts[k];
                document.getElementById('b-'+id).style.width = (pts[k]/25*100)+'%';
            });
            const maxVal = Math.max(pts.FOGO, pts.AR, pts.AGUA, pts.TERRA);
            if(pts.FOGO===maxVal) document.getElementById('cp-fogo').classList.add('predominante');
            if(pts.AR===maxVal) document.getElementById('cp-ar').classList.add('predominante');
            if(pts.AGUA===maxVal) document.getElementById('cp-agua').classList.add('predominante');
            if(pts.TERRA===maxVal) document.getElementById('cp-terra').classList.add('predominante');

            // Estilo
            let maiorEstilo = Object.keys(estiloData).length > 0 ? Object.keys(estiloData).reduce((a,b)=>estiloData[a]>estiloData[b]?a:b) : "EM ANÁLISE";
            document.getElementById('p-estilo').innerText = maiorEstilo.toUpperCase();
            document.getElementById('p-estilo-desc').innerText = getDescEstilo(maiorEstilo);
            
            // Estilo: Gera Gráfico e Legenda Manual Lateral
            renderChartWithLegend('chart-estilo', 'legend-estilo', estiloData);

            // Grids
            renderGrid(visualGroups, 'grid-sensorial');
            renderGrid(lifeGroups, 'grid-lifestyle');

            // 3. EXPORTAR
            const el = document.getElementById('folha-a4');
            el.style.display = 'block';
            setTimeout(async () => {
                const opt = {
                    margin: 0,
                    filename: `NeuroBriefing_${dados.cliente}.pdf`,
                    image: { type: 'jpeg', quality: 1 },
                    html2canvas: { scale: 4, useCORS: true }, 
                    jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
                };
                await html2pdf().set(opt).from(el).save();
                el.style.display = 'none';
                btn.innerText = originalTxt; btn.disabled = false;
            }, 800);
        }

        // Gera Gráfico + Legenda HTML
        function renderChartWithLegend(chartId, legendId, dataObj) {
            const ctx = document.getElementById(chartId);
            const legBox = document.getElementById(legendId);
            if(!ctx || !legBox) return;

            const labels = Object.keys(dataObj);
            const vals = Object.values(dataObj);
            const total = vals.reduce((a,b)=>a+b,0);

            // HTML Legenda
            let html = '';
            labels.forEach((l, i) => {
                const color = PALETA[i % PALETA.length];
                const pct = Math.round((vals[i]/total)*100);
                html += `<div style="display:flex;align-items:center;margin-bottom:2px;line-height:1;"><div style="width:5px;height:5px;background:${color};margin-right:3px;border-radius:50%;"></div><span style="font-weight:600;color:#333;">${l} (${pct}%)</span></div>`;
            });
            legBox.innerHTML = html;

            new Chart(ctx, {
                type: 'doughnut',
                data: { labels: labels, datasets: [{ data: vals, backgroundColor: PALETA, borderWidth: 0 }] },
                options: {
                    responsive: true, maintainAspectRatio: false, animation: false, cutout: '65%',
                    plugins: { legend: { display: false }, tooltip: { enabled: false } }
                }
            });
        }

        // Renderiza Grid (Lado a Lado)
        function renderGrid(groups, containerId) {
            const grid = document.getElementById(containerId);
            grid.innerHTML = '';
            Object.keys(groups).forEach((cat, idx) => {
                const safeId = `ch-${containerId}-${idx}`;
                const items = groups[cat];
                const total = items.reduce((a,b)=>a+b.val, 0);
                
                // HTML Legenda
                let leg = '';
                let dataMap = {};
                items.forEach((it, i) => {
                    const color = PALETA[i % PALETA.length];
                    const pct = Math.round((it.val/total)*100);
                    leg += `<div class="leg-row"><div class="leg-box" style="background:${color}"></div><span class="leg-txt">${it.opt} (${pct}%)</span></div>`;
                    dataMap[it.opt] = it.val;
                });

                const div = document.createElement('div');
                div.className = 'chart-card';
                div.innerHTML = `
                    <div class="card-left"><div class="canvas-box"><canvas id="${safeId}"></canvas></div></div>
                    <div class="card-right"><div class="cc-title">${cat}</div><div class="cc-legend">${leg}</div></div>
                `;
                grid.appendChild(div);
                
                // ChartJS (sem legenda interna)
                new Chart(document.getElementById(safeId), {
                    type: 'doughnut',
                    data: { labels: Object.keys(dataMap), datasets: [{ data: Object.values(dataMap), backgroundColor: PALETA, borderWidth: 0 }] },
                    options: {
                        responsive: true, maintainAspectRatio: false, animation: false, cutout: '65%',
                        plugins: { legend: { display: false }, tooltip: { enabled: false } }
                    }
                });
            });
        }

        function getDescEstilo(est) {
            if(est.includes('Moderno')) return 'Funcionalidade, linhas retas e clareza visual.';
            if(est.includes('Clássico')) return 'Simetria, nobreza e valorização da história.';
            if(est.includes('Industrial')) return 'Metais, concreto aparente e estética urbana.';
            if(est.includes('Rústico')) return 'Materiais naturais brutos e texturas.';
            if(est.includes('Natural')) return 'Conexão profunda com a natureza.';
            return 'Perfil personalizado.';
        }

        init();
    </script>
</body>
</html>